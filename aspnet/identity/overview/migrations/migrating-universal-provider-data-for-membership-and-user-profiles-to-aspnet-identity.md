---
uid: identity/overview/migrations/migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity
title: 将通用提供程序的数据迁移的成员身份和用户配置文件到 ASP.NET 标识 (C#) |Microsoft Docs
author: rustd
description: 本教程中介绍的步骤所需迁移用户和角色的数据和创建使用现有应用的通用提供程序的用户配置文件数据...
ms.author: aspnetcontent
manager: wpickett
ms.date: 12/13/2013
ms.topic: article
ms.assetid: 2e260430-d13c-4658-bd05-e256fc0d63b8
ms.technology: ''
msc.legacyurl: /identity/overview/migrations/migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: dce27af273adb45c1ad8f07790c98d2fa5862f67
ms.sourcegitcommit: 953ff9ea4369f154d6fd0239599279ddd3280009
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 07/03/2018
ms.locfileid: "37377955"
---
<a name="migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity-c"></a><span data-ttu-id="2243c-103">将通用提供程序的数据迁移的成员身份和用户配置文件到 ASP.NET 标识 (C#)</span><span class="sxs-lookup"><span data-stu-id="2243c-103">Migrating Universal Provider Data for Membership and User Profiles to ASP.NET Identity (C#)</span></span>
====================
<span data-ttu-id="2243c-104">通过[Pranav rastogi 撰写](https://github.com/rustd)， [Rick Anderson](https://github.com/Rick-Anderson)， [Robert McMurray](https://github.com/rmcmurray)， [Suhas Joshi](https://github.com/suhasj)</span><span class="sxs-lookup"><span data-stu-id="2243c-104">by [Pranav Rastogi](https://github.com/rustd), [Rick Anderson](https://github.com/Rick-Anderson), [Robert McMurray](https://github.com/rmcmurray), [Suhas Joshi](https://github.com/suhasj)</span></span>

> <span data-ttu-id="2243c-105">本教程介绍所需迁移用户和角色的数据和创建使用现有的应用程序到 ASP.NET 标识模型的通用提供程序的用户配置文件数据的步骤。</span><span class="sxs-lookup"><span data-stu-id="2243c-105">This tutorial describes the steps that are necessary to migrate user and role data and user profile data created using Universal Providers of an existing application to the ASP.NET Identity model.</span></span> <span data-ttu-id="2243c-106">迁移用户配置文件数据可在具有 SQL 成员身份的应用程序，此处提及的方法。</span><span class="sxs-lookup"><span data-stu-id="2243c-106">The approach mentioned here to migrate user profile data can be used in an application with SQL membership as well.</span></span>


<span data-ttu-id="2243c-107">使用 Visual Studio 2013 的发布，ASP.NET 团队引入了新的 ASP.NET 标识系统，并可以阅读更多有关该发行版[此处](../../index.md)。</span><span class="sxs-lookup"><span data-stu-id="2243c-107">With the release of Visual Studio 2013, the ASP.NET team introduced a new ASP.NET Identity system, and you can read more about that release [here](../../index.md).</span></span> <span data-ttu-id="2243c-108">后续文章将从 web 应用程序迁移[到新的标识系统的 SQL 成员资格](migrating-an-existing-website-from-sql-membership-to-aspnet-identity.md)，本文将演示迁移现有应用程序的用户和角色管理的提供程序模型的步骤为新的身份标识模型。</span><span class="sxs-lookup"><span data-stu-id="2243c-108">Following up on the article to migrate web applications from [SQL Membership to the new Identity system](migrating-an-existing-website-from-sql-membership-to-aspnet-identity.md), this article illustrates the steps to migrate existing applications that follow the Providers model for user and role management to the new Identity model.</span></span> <span data-ttu-id="2243c-109">本教程的焦点将主要在迁移用户配置文件数据，以无缝地将其挂接到新系统上。</span><span class="sxs-lookup"><span data-stu-id="2243c-109">The focus of this tutorial will be primarily on migrating the user profile data to seamlessly hook it into the new system.</span></span> <span data-ttu-id="2243c-110">迁移用户和角色的信息是类似的 SQL 成员身份。</span><span class="sxs-lookup"><span data-stu-id="2243c-110">Migrating user and role information is similar for SQL membership.</span></span> <span data-ttu-id="2243c-111">可以使用 SQL 成员资格应用程序中使用迁移配置文件数据时遵循的方法。</span><span class="sxs-lookup"><span data-stu-id="2243c-111">The approach followed to migrate profile data can be used in an application with SQL membership as well.</span></span>

<span data-ttu-id="2243c-112">例如，我们将开始使用 Visual Studio 2012 使用的提供程序模型创建的 web 应用。</span><span class="sxs-lookup"><span data-stu-id="2243c-112">As an example, we will start with a web app created using Visual Studio 2012 which uses the Providers model.</span></span> <span data-ttu-id="2243c-113">我们将然后添加代码来配置文件管理、 注册用户、 添加的用户配置文件数据、 将数据库架构，迁移，然后将更改应用程序使用的标识系统的用户和角色管理。</span><span class="sxs-lookup"><span data-stu-id="2243c-113">We'll then add code for profile management, register a user, add profile data for the users, migrate the database schema, and then change the application to use the Identity system for user and role management.</span></span> <span data-ttu-id="2243c-114">为迁移的测试，创建使用通用提供程序的用户应该能够以用户身份登录，新用户应能注册。</span><span class="sxs-lookup"><span data-stu-id="2243c-114">As a test of migration, users created using Universal Providers should be able to log in and new users should be able to register.</span></span>

> [!NOTE]
> <span data-ttu-id="2243c-115">您可以找到完整的示例在[ https://github.com/suhasj/UniversalProviders-Identity-Migrations ](https://github.com/suhasj/UniversalProviders-Identity-Migrations)。</span><span class="sxs-lookup"><span data-stu-id="2243c-115">You can find the complete sample at [https://github.com/suhasj/UniversalProviders-Identity-Migrations](https://github.com/suhasj/UniversalProviders-Identity-Migrations).</span></span>


## <a name="profile-data-migration-summary"></a><span data-ttu-id="2243c-116">配置文件数据迁移摘要</span><span class="sxs-lookup"><span data-stu-id="2243c-116">Profile data migration summary</span></span>

<span data-ttu-id="2243c-117">在开始之前与的迁移，让我们看一下在提供程序模型中存储配置文件数据的体验。</span><span class="sxs-lookup"><span data-stu-id="2243c-117">Before starting with the migrations, let us look at the experience of storing profile data in the Providers model.</span></span> <span data-ttu-id="2243c-118">应用程序可以通过多种方式存储用户的配置文件数据，最常见在它们之间正在使用内置的配置文件提供程序和通用提供程序一起提供。</span><span class="sxs-lookup"><span data-stu-id="2243c-118">Profile data for application users can be stored in multiple ways, the most common among them being using the inbuilt profile providers shipped along with the Universal Providers.</span></span> <span data-ttu-id="2243c-119">这些步骤将包括</span><span class="sxs-lookup"><span data-stu-id="2243c-119">The steps would include</span></span>

1. <span data-ttu-id="2243c-120">添加具有用来存储配置文件数据的属性的类。</span><span class="sxs-lookup"><span data-stu-id="2243c-120">Add a class that has properties used to store Profile data.</span></span>
2. <span data-ttu-id="2243c-121">添加扩展 ProfileBase，并实现方法以获取用户的更高版本的配置文件数据的类。</span><span class="sxs-lookup"><span data-stu-id="2243c-121">Add a class that extends 'ProfileBase' and implements methods to get the above profile data for the user.</span></span>
3. <span data-ttu-id="2243c-122">使用默认配置文件提供程序中的启用*web.config*文件，并定义用于访问配置文件信息的第 2 步中声明的类。</span><span class="sxs-lookup"><span data-stu-id="2243c-122">Enable using default profile providers in the *web.config* file and define the class declared in step #2 to be used in accessing profile information.</span></span>

<span data-ttu-id="2243c-123">配置文件信息存储为序列化的 xml 和二进制数据在数据库中的配置文件表中。</span><span class="sxs-lookup"><span data-stu-id="2243c-123">The profile information is stored as serialized xml and binary data in the 'Profiles' table in the database.</span></span>

<span data-ttu-id="2243c-124">迁移应用程序以使用新的 ASP.NET 标识系统之后, 是反序列化的配置文件信息并将其存储为用户类上的属性中。</span><span class="sxs-lookup"><span data-stu-id="2243c-124">After migrating the application to use the new ASP.NET Identity system, the profile information is deserialized and stored as properties on the user class.</span></span> <span data-ttu-id="2243c-125">然后可以将每个属性映射到用户表中的列上。</span><span class="sxs-lookup"><span data-stu-id="2243c-125">Each property can then be mapped onto columns in the user table.</span></span> <span data-ttu-id="2243c-126">其优点在于属性都可以得到直接使用 user 类除了无需序列化/反序列化数据信息时对其进行访问的时间。</span><span class="sxs-lookup"><span data-stu-id="2243c-126">The advantage here is that the properties can be worked on directly using the user class in addition to not having to serialize/deserialize data information each time when accessing it.</span></span>

## <a name="getting-started"></a><span data-ttu-id="2243c-127">入门</span><span class="sxs-lookup"><span data-stu-id="2243c-127">Getting Started</span></span>

1. <span data-ttu-id="2243c-128">在 Visual Studio 2012 中创建新的 ASP.NET 4.5 Web 窗体应用程序。</span><span class="sxs-lookup"><span data-stu-id="2243c-128">Create a new ASP.NET 4.5 Web Forms application in Visual Studio 2012.</span></span> <span data-ttu-id="2243c-129">当前的示例使用 Web 窗体模板，但您也可以使用 MVC 应用程序。</span><span class="sxs-lookup"><span data-stu-id="2243c-129">The current sample uses the Web Forms template, but you could use MVC Application as well.</span></span>  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image1.jpg)
2. <span data-ttu-id="2243c-130">创建一个新文件夹模型来存储配置文件信息</span><span class="sxs-lookup"><span data-stu-id="2243c-130">Create a new folder 'Models' to store profile information</span></span>  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image1.png)
3. <span data-ttu-id="2243c-131">作为示例，让我们在配置文件中存储的出生、 城市、 高度和权重的用户的日期。</span><span class="sxs-lookup"><span data-stu-id="2243c-131">As an example, let us store the date of birth, city, height and weight of the user in profile.</span></span> <span data-ttu-id="2243c-132">身高和体重存储为一个名为 PersonalStats 的自定义类。</span><span class="sxs-lookup"><span data-stu-id="2243c-132">The height and weight are stored as a custom class called 'PersonalStats'.</span></span> <span data-ttu-id="2243c-133">若要存储和检索配置文件，我们需要一个类以扩展 ProfileBase。</span><span class="sxs-lookup"><span data-stu-id="2243c-133">To store and retrieve the profile, we need a class that extends 'ProfileBase'.</span></span> <span data-ttu-id="2243c-134">让我们创建一个新类 AppProfile 获取并存储配置文件信息。</span><span class="sxs-lookup"><span data-stu-id="2243c-134">Let's create a new class 'AppProfile' to get and store profile information.</span></span>

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample1.cs)]
4. <span data-ttu-id="2243c-135">启用配置文件中的*web.config*文件。</span><span class="sxs-lookup"><span data-stu-id="2243c-135">Enable profile in the *web.config* file.</span></span> <span data-ttu-id="2243c-136">输入要用来存储/检索用户信息在步骤 #3 中创建的类名。</span><span class="sxs-lookup"><span data-stu-id="2243c-136">Enter the class name to be used to store/retrieve user information created in step #3.</span></span>

    [!code-xml[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample2.xml)]
5. <span data-ttu-id="2243c-137">若要从用户获取配置文件数据并将其存储的帐户文件夹中添加 web 窗体页。</span><span class="sxs-lookup"><span data-stu-id="2243c-137">Add a web forms page in 'Account' folder to get the profile data from the user and store it.</span></span> <span data-ttu-id="2243c-138">右键单击项目并选择添加新项。</span><span class="sxs-lookup"><span data-stu-id="2243c-138">Right click on project and select 'Add new Item'.</span></span> <span data-ttu-id="2243c-139">添加新的 webforms 页与母版页 AddProfileData.aspx。</span><span class="sxs-lookup"><span data-stu-id="2243c-139">Add a new webforms page with master page 'AddProfileData.aspx'.</span></span> <span data-ttu-id="2243c-140">将以下内容复制的主要内容部分中：</span><span class="sxs-lookup"><span data-stu-id="2243c-140">Copy the following in the 'MainContent' section:</span></span>

    [!code-html[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample3.html)]

   <span data-ttu-id="2243c-141">在代码隐藏中添加以下代码：</span><span class="sxs-lookup"><span data-stu-id="2243c-141">Add the following code in the code behind:</span></span>

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample4.cs)]

   <span data-ttu-id="2243c-142">添加命名空间下的 AppProfile 类定义以删除编译错误。</span><span class="sxs-lookup"><span data-stu-id="2243c-142">Add the namespace under which AppProfile class is defined to remove the compilation errors.</span></span>
6. <span data-ttu-id="2243c-143">运行应用并使用用户名创建一个新用户**olduser。**</span><span class="sxs-lookup"><span data-stu-id="2243c-143">Run the app and create a new user with username '**olduser'.**</span></span> <span data-ttu-id="2243c-144">导航到 AddProfileData 页，并添加用户的配置文件信息。</span><span class="sxs-lookup"><span data-stu-id="2243c-144">Navigate to the 'AddProfileData' page and add profile information for the user.</span></span>  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image2.png)

<span data-ttu-id="2243c-145">你可以验证的数据存储为序列化的 xml 中使用服务器资源管理器窗口的配置文件表。</span><span class="sxs-lookup"><span data-stu-id="2243c-145">You can verify that the data is stored as serialized xml in the 'Profiles' table using the Server Explorer window.</span></span> <span data-ttu-id="2243c-146">在 Visual Studio 中，从视图菜单中，选择服务器资源管理器。</span><span class="sxs-lookup"><span data-stu-id="2243c-146">In Visual Studio, from 'View' menu, choose 'Server Explorer'.</span></span> <span data-ttu-id="2243c-147">应为数据库中定义的数据连接*web.config*文件。</span><span class="sxs-lookup"><span data-stu-id="2243c-147">There should be a data connection for the database defined in the *web.config* file.</span></span> <span data-ttu-id="2243c-148">单击数据连接显示不同的子类别。</span><span class="sxs-lookup"><span data-stu-id="2243c-148">Clicking on the data connection shows different sub categories.</span></span> <span data-ttu-id="2243c-149">展开表以显示在不同的表在数据库中，然后右键单击配置文件，并选择显示表数据以查看配置文件表中存储的配置文件数据。</span><span class="sxs-lookup"><span data-stu-id="2243c-149">Expand 'Tables' to show the different tables in your database, then right click on 'Profiles' and choose 'Show Table Data' to view the profile data stored in the Profiles table.</span></span>

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image3.png)

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image4.png)

## <a name="migrating-database-schema"></a><span data-ttu-id="2243c-150">迁移数据库架构</span><span class="sxs-lookup"><span data-stu-id="2243c-150">Migrating database schema</span></span>

<span data-ttu-id="2243c-151">若要使现有数据库使用的标识系统，我们需要更新标识数据库来支持我们添加到原始数据库的字段中的架构。</span><span class="sxs-lookup"><span data-stu-id="2243c-151">To make the existing database work with the Identity system, we need to update the schema in the Identity database to support the fields we added to the original database.</span></span> <span data-ttu-id="2243c-152">这可以使用 SQL 脚本来创建新表并将复制的现有信息。</span><span class="sxs-lookup"><span data-stu-id="2243c-152">This can be done using SQL scripts to create new tables and copy the existing information.</span></span> <span data-ttu-id="2243c-153">在服务器资源管理器窗口中，展开 DefaultConnection 以显示表。</span><span class="sxs-lookup"><span data-stu-id="2243c-153">In the 'Server Explorer' window, expand the 'DefaultConnection' to display the tables.</span></span> <span data-ttu-id="2243c-154">右键单击表并选择新建查询</span><span class="sxs-lookup"><span data-stu-id="2243c-154">Right click Tables and select 'New Query'</span></span>

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image5.png)

<span data-ttu-id="2243c-155">将从 SQL 脚本粘贴[ https://raw.github.com/suhasj/UniversalProviders-Identity-Migrations/master/Migration.txt ](https://raw.github.com/suhasj/UniversalProviders-Identity-Migrations/master/Migration.txt)并运行它。</span><span class="sxs-lookup"><span data-stu-id="2243c-155">Paste the SQL script from [https://raw.github.com/suhasj/UniversalProviders-Identity-Migrations/master/Migration.txt](https://raw.github.com/suhasj/UniversalProviders-Identity-Migrations/master/Migration.txt) and run it.</span></span> <span data-ttu-id="2243c-156">如果刷新 DefaultConnection 时，我们可以看到添加的新表。</span><span class="sxs-lookup"><span data-stu-id="2243c-156">If the 'DefaultConnection' is refreshed, we can see that the new tables are added.</span></span> <span data-ttu-id="2243c-157">您可以检查以查看已迁移的信息的表中的数据。</span><span class="sxs-lookup"><span data-stu-id="2243c-157">You can check the data inside the tables to see that the information has been migrated.</span></span>

![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image6.png)

## <a name="migrating-the-application-to-use-aspnet-identity"></a><span data-ttu-id="2243c-158">迁移应用程序以使用 ASP.NET 标识</span><span class="sxs-lookup"><span data-stu-id="2243c-158">Migrating the application to use ASP.NET Identity</span></span>

1. <span data-ttu-id="2243c-159">安装 Nuget 包所需的 ASP.NET 标识：</span><span class="sxs-lookup"><span data-stu-id="2243c-159">Install the Nuget packages needed for ASP.NET Identity:</span></span>

    - <span data-ttu-id="2243c-160">Microsoft.AspNet.Identity.EntityFramework</span><span class="sxs-lookup"><span data-stu-id="2243c-160">Microsoft.AspNet.Identity.EntityFramework</span></span>
    - <span data-ttu-id="2243c-161">Microsoft.AspNet.Identity.Owin</span><span class="sxs-lookup"><span data-stu-id="2243c-161">Microsoft.AspNet.Identity.Owin</span></span>
    - <span data-ttu-id="2243c-162">Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="2243c-162">Microsoft.Owin.Host.SystemWeb</span></span>
    - <span data-ttu-id="2243c-163">Microsoft.Owin.Security.Facebook</span><span class="sxs-lookup"><span data-stu-id="2243c-163">Microsoft.Owin.Security.Facebook</span></span>
    - <span data-ttu-id="2243c-164">Microsoft.Owin.Security.Google</span><span class="sxs-lookup"><span data-stu-id="2243c-164">Microsoft.Owin.Security.Google</span></span>
    - <span data-ttu-id="2243c-165">Microsoft.Owin.Security.MicrosoftAccount</span><span class="sxs-lookup"><span data-stu-id="2243c-165">Microsoft.Owin.Security.MicrosoftAccount</span></span>
    - <span data-ttu-id="2243c-166">Microsoft.Owin.Security.Twitter</span><span class="sxs-lookup"><span data-stu-id="2243c-166">Microsoft.Owin.Security.Twitter</span></span>

   <span data-ttu-id="2243c-167">管理 Nuget 包的详细信息可在[此处](http://docs.nuget.org/docs/start-here/Managing-NuGet-Packages-Using-The-Dialog)</span><span class="sxs-lookup"><span data-stu-id="2243c-167">More information on managing Nuget packages can be found [here](http://docs.nuget.org/docs/start-here/Managing-NuGet-Packages-Using-The-Dialog)</span></span>
2. <span data-ttu-id="2243c-168">若要使用表中的现有数据，我们需要创建模型类映射回表并将它们连接起来，标识系统中。</span><span class="sxs-lookup"><span data-stu-id="2243c-168">To work with existing data in the table, we need to create model classes which map back to the tables and hook them up in the Identity system.</span></span> <span data-ttu-id="2243c-169">作为标识协定的一部分，在 model 类应实现 Identity.Core dll 中定义的接口，或可以扩展现有 Microsoft.AspNet.Identity.EntityFramework 中提供这些接口的实现。</span><span class="sxs-lookup"><span data-stu-id="2243c-169">As part of the Identity contract, the model classes should either implement the interfaces defined in the Identity.Core dll or can extend the existing implementation of these interfaces available in Microsoft.AspNet.Identity.EntityFramework.</span></span> <span data-ttu-id="2243c-170">我们将角色、 用户登录名和用户声明使用现有的类。</span><span class="sxs-lookup"><span data-stu-id="2243c-170">We will be using the existing classes for role, user logins and user claims.</span></span> <span data-ttu-id="2243c-171">我们需要我们的示例使用自定义用户。</span><span class="sxs-lookup"><span data-stu-id="2243c-171">We need to use a custom user for our sample.</span></span> <span data-ttu-id="2243c-172">右键单击项目并创建新文件夹 IdentityModels。</span><span class="sxs-lookup"><span data-stu-id="2243c-172">Right click on the project and create new folder 'IdentityModels'.</span></span> <span data-ttu-id="2243c-173">添加新的用户类，如下所示：</span><span class="sxs-lookup"><span data-stu-id="2243c-173">Add a new 'User' class as shown below:</span></span>

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample5.cs)]

   <span data-ttu-id="2243c-174">请注意，ProfileInfo 现在是用户类的属性。</span><span class="sxs-lookup"><span data-stu-id="2243c-174">Notice that the 'ProfileInfo' is now a property on the user class.</span></span> <span data-ttu-id="2243c-175">因此我们可以使用用户类来直接使用配置文件数据。</span><span class="sxs-lookup"><span data-stu-id="2243c-175">Hence we can use the user class to directly work with profile data.</span></span>

<span data-ttu-id="2243c-176">复制中的文件**IdentityModels**并**IdentityAccount**中下载源的文件夹 ( [ https://github.com/suhasj/UniversalProviders-Identity-Migrations/tree/master/UniversalProviders-Identity-Migrations ](https://github.com/suhasj/UniversalProviders-Identity-Migrations/tree/master/UniversalProviders-Identity-Migrations) )。</span><span class="sxs-lookup"><span data-stu-id="2243c-176">Copy the files in the **IdentityModels** and **IdentityAccount** folders from the download source ( [https://github.com/suhasj/UniversalProviders-Identity-Migrations/tree/master/UniversalProviders-Identity-Migrations](https://github.com/suhasj/UniversalProviders-Identity-Migrations/tree/master/UniversalProviders-Identity-Migrations) ).</span></span> <span data-ttu-id="2243c-177">这些具有剩余模型类和所需的用户和角色管理使用 ASP.NET 标识 Api 的新页。</span><span class="sxs-lookup"><span data-stu-id="2243c-177">These have the remaining model classes and the new pages needed for user and role management using the ASP.NET Identity APIs.</span></span> <span data-ttu-id="2243c-178">使用的方法类似于 SQL 成员资格，可以找到详细的说明[此处](migrating-an-existing-website-from-sql-membership-to-aspnet-identity.md)。</span><span class="sxs-lookup"><span data-stu-id="2243c-178">The approach used is similar to the SQL Membership and the detailed explanation can be found [here](migrating-an-existing-website-from-sql-membership-to-aspnet-identity.md).</span></span>

[!INCLUDE[](../../../includes/identity/alter-command-exception.md)]

## <a name="copying-profile-data-to-the-new-tables"></a><span data-ttu-id="2243c-179">配置文件将数据复制到新表</span><span class="sxs-lookup"><span data-stu-id="2243c-179">Copying Profile data to the new tables</span></span>

<span data-ttu-id="2243c-180">前面曾提到，我们需要反序列化配置文件表中的 xml 数据并将其存储在 AspNetUsers 表中的列。</span><span class="sxs-lookup"><span data-stu-id="2243c-180">As mentioned earlier, we need to deserialize the xml data in the Profiles tables and store it in the columns of the AspNetUsers table.</span></span> <span data-ttu-id="2243c-181">因此，剩下的就是填充这些列使用必要的数据在上一步骤中的用户表中创建新列。</span><span class="sxs-lookup"><span data-stu-id="2243c-181">The new columns were created in the users table in the previous step so all that is left is to populate those columns with the necessary data.</span></span> <span data-ttu-id="2243c-182">若要执行此操作，我们将使用一次运行以填充新创建的用户表中列的控制台应用程序。</span><span class="sxs-lookup"><span data-stu-id="2243c-182">To do this, we will use a console application which is run once to populate the newly created columns in the users table.</span></span>

1. <span data-ttu-id="2243c-183">在现有解决方案中创建新的控制台应用程序。</span><span class="sxs-lookup"><span data-stu-id="2243c-183">Create a new console application in the exiting solution.</span></span>  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image2.jpg)
2. <span data-ttu-id="2243c-184">安装 Entity Framework 包的最新版本。</span><span class="sxs-lookup"><span data-stu-id="2243c-184">Install the latest version of the Entity Framework package.</span></span>
3. <span data-ttu-id="2243c-185">添加对该控制台应用程序的引用上面创建的 web 应用程序。</span><span class="sxs-lookup"><span data-stu-id="2243c-185">Add the web application created above as a reference to the console application.</span></span> <span data-ttu-id="2243c-186">为此，右击项目，然后添加引用，然后解决方案，然后单击项目，并单击确定。</span><span class="sxs-lookup"><span data-stu-id="2243c-186">To do this right click on Project, then 'Add References', then Solution, then click on the project and click OK.</span></span>
4. <span data-ttu-id="2243c-187">复制下面的 Program.cs 类中的代码。</span><span class="sxs-lookup"><span data-stu-id="2243c-187">Copy the below code in the Program.cs class.</span></span> <span data-ttu-id="2243c-188">此逻辑读取的每个用户配置文件数据、 将其作为 ProfileInfo 对象序列化并将其存储回数据库。</span><span class="sxs-lookup"><span data-stu-id="2243c-188">This logic reads profile data for each user, serializes it as 'ProfileInfo' object and stores it back to the database.</span></span>

    [!code-csharp[Main](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/samples/sample6.cs)]

   <span data-ttu-id="2243c-189">所使用的模型的一些文件夹中定义 IdentityModels 的 web 应用程序项目，因此你必须将包含相应的命名空间。</span><span class="sxs-lookup"><span data-stu-id="2243c-189">Some of the models used are defined in the 'IdentityModels' folder of the web application project, so you must include the corresponding namespaces.</span></span>
5. <span data-ttu-id="2243c-190">上面的代码适用于应用程序中的数据库文件\_前面步骤中创建的 web 应用程序项目的数据文件夹。</span><span class="sxs-lookup"><span data-stu-id="2243c-190">The above code works on the database file in the App\_Data folder of the web application project created in the previous steps.</span></span> <span data-ttu-id="2243c-191">若要引用的请使用 web 应用程序的 web.config 中的连接字符串更新控制台应用程序的 app.config 文件中的连接字符串。</span><span class="sxs-lookup"><span data-stu-id="2243c-191">To reference that, update the connection string in the app.config file of the console application with the connection string in the web.config of the web application.</span></span> <span data-ttu-id="2243c-192">此外提供 AttachDbFilename 属性中的完整物理路径。</span><span class="sxs-lookup"><span data-stu-id="2243c-192">Also provide the complete physical path in the 'AttachDbFilename' property.</span></span>
6. <span data-ttu-id="2243c-193">打开命令提示符并导航到更高版本的控制台应用程序的 bin 文件夹。</span><span class="sxs-lookup"><span data-stu-id="2243c-193">Open a command prompt and navigate to the bin folder of the above console application.</span></span> <span data-ttu-id="2243c-194">运行可执行文件并查看日志输出，如在下图中所示。</span><span class="sxs-lookup"><span data-stu-id="2243c-194">Run the executable and review the log output as shown in the following image.</span></span>  
    ![](migrating-universal-provider-data-for-membership-and-user-profiles-to-aspnet-identity/_static/image3.jpg)
7. <span data-ttu-id="2243c-195">在服务器资源管理器中打开 AspNetUsers 表，并验证保存属性的新列中的数据。</span><span class="sxs-lookup"><span data-stu-id="2243c-195">Open the 'AspNetUsers' table in the Server Explorer and verify the data in the new columns that hold the properties.</span></span> <span data-ttu-id="2243c-196">它们应更新相应的属性值。</span><span class="sxs-lookup"><span data-stu-id="2243c-196">They should be updated with the corresponding property values.</span></span>

## <a name="verify-functionality"></a><span data-ttu-id="2243c-197">验证功能</span><span class="sxs-lookup"><span data-stu-id="2243c-197">Verify functionality</span></span>

<span data-ttu-id="2243c-198">使用新添加的成员资格页使用 ASP.NET 标识登录的用户从旧数据库实现。</span><span class="sxs-lookup"><span data-stu-id="2243c-198">Use the newly added membership pages that are implemented using ASP.NET Identity to login a user from the old database.</span></span> <span data-ttu-id="2243c-199">用户应该能够在使用相同的凭据进行登录。</span><span class="sxs-lookup"><span data-stu-id="2243c-199">The user should be able to log in using the same credentials.</span></span> <span data-ttu-id="2243c-200">请尝试其他功能类似于添加 OAuth，创建新用户，更改密码，添加角色，将用户添加到角色，等等。</span><span class="sxs-lookup"><span data-stu-id="2243c-200">Try the other functionalities like adding OAuth, creating a new user, changing a password, adding roles, add users to roles, etc.</span></span>

<span data-ttu-id="2243c-201">应检索和存储在用户表中的旧用户和新用户的配置文件数据。</span><span class="sxs-lookup"><span data-stu-id="2243c-201">The Profile data for the old user and the new users should be retrieved and stored in the users table.</span></span> <span data-ttu-id="2243c-202">应不再引用旧表。</span><span class="sxs-lookup"><span data-stu-id="2243c-202">The old table should no longer be referenced.</span></span>

## <a name="conclusion"></a><span data-ttu-id="2243c-203">结束语</span><span class="sxs-lookup"><span data-stu-id="2243c-203">Conclusion</span></span>

<span data-ttu-id="2243c-204">本文所述的 web 应用程序迁移到 ASP.NET 标识的成员身份使用提供程序模型的过程。</span><span class="sxs-lookup"><span data-stu-id="2243c-204">The article described the process of migrating web applications that used the provider model for membership to ASP.NET Identity.</span></span> <span data-ttu-id="2243c-205">此外文章所述的用户要挂钩到标识系统的迁移配置文件数据。</span><span class="sxs-lookup"><span data-stu-id="2243c-205">The article additionally outlined migrating profile data for users to be hooked into the Identity system.</span></span> <span data-ttu-id="2243c-206">请留下注释下面的问题和迁移您的应用程序时遇到的问题。</span><span class="sxs-lookup"><span data-stu-id="2243c-206">Please leave comments below for questions and issues encountered when you migrate your app.</span></span>

<span data-ttu-id="2243c-207">*感谢 Rick Anderson 和 Robert McMurray 有关本文的审阅。*</span><span class="sxs-lookup"><span data-stu-id="2243c-207">*Thanks to Rick Anderson and Robert McMurray for reviewing the article.*</span></span>
