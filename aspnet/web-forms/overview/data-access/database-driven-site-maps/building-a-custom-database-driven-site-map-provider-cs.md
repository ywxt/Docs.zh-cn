---
uid: web-forms/overview/data-access/database-driven-site-maps/building-a-custom-database-driven-site-map-provider-cs
title: 生成自定义数据库驱动站点地图提供程序 (C#) |Microsoft Docs
author: rick-anderson
description: 在 ASP.NET 2.0 中的默认站点地图提供静态的 XML 文件中检索其数据。 适用于许多小型和中等大小的基于 XML 的提供程序时...
ms.author: aspnetcontent
ms.date: 06/26/2007
ms.assetid: 04b7591d-106f-4f05-87e9-d416cb65a8a6
msc.legacyurl: /web-forms/overview/data-access/database-driven-site-maps/building-a-custom-database-driven-site-map-provider-cs
msc.type: authoredcontent
ms.openlocfilehash: fdc6ddeac800279a638911f1f64772c49fff5449
ms.sourcegitcommit: b28cd0313af316c051c2ff8549865bff67f2fbb4
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 07/05/2018
ms.locfileid: "37807107"
---
<a name="building-a-custom-database-driven-site-map-provider-c"></a><span data-ttu-id="9b8c4-104">生成自定义数据库驱动站点地图提供程序 (C#)</span><span class="sxs-lookup"><span data-stu-id="9b8c4-104">Building a Custom Database-Driven Site Map Provider (C#)</span></span>
====================
<span data-ttu-id="9b8c4-105">通过[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="9b8c4-105">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="9b8c4-106">[下载代码](http://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_62_CS.zip)或[下载 PDF](building-a-custom-database-driven-site-map-provider-cs/_static/datatutorial62cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="9b8c4-106">[Download Code](http://download.microsoft.com/download/3/9/f/39f92b37-e92e-4ab3-909e-b4ef23d01aa3/ASPNET_Data_Tutorial_62_CS.zip) or [Download PDF](building-a-custom-database-driven-site-map-provider-cs/_static/datatutorial62cs1.pdf)</span></span>

> <span data-ttu-id="9b8c4-107">在 ASP.NET 2.0 中的默认站点地图提供静态的 XML 文件中检索其数据。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-107">The default site map provider in ASP.NET 2.0 retrieves its data from a static XML file.</span></span> <span data-ttu-id="9b8c4-108">适用于许多小型和中型 Web 站点的基于 XML 的提供程序时，更大的 Web 应用程序需要更多动态站点地图。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-108">While the XML-based provider is suitable to many small and medium-sized Web sites, larger Web applications require a more dynamic site map.</span></span> <span data-ttu-id="9b8c4-109">在本教程中，我们将构建自定义站点地图提供程序的业务逻辑层中检索其数据，这又从数据库检索数据。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-109">In this tutorial we'll build a custom site map provider that retrieves its data from the Business Logic Layer, which in turn retrieves data from the database.</span></span>


## <a name="introduction"></a><span data-ttu-id="9b8c4-110">介绍</span><span class="sxs-lookup"><span data-stu-id="9b8c4-110">Introduction</span></span>

<span data-ttu-id="9b8c4-111">ASP.NET 2.0 的站点地图功能使页面开发人员的 XML 文件中，如定义一些持久介质中的 web 应用程序的站点图。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-111">ASP.NET 2.0 s site map feature enables a page developer to define a web application s site map in some persistent medium, such as in an XML file.</span></span> <span data-ttu-id="9b8c4-112">定义后，可以通过以编程方式访问站点地图数据[`SiteMap`类](https://msdn.microsoft.com/library/system.web.sitemap.aspx)中[`System.Web`命名空间](https://msdn.microsoft.com/library/system.web.aspx)或通过各种导航 Web 控件，如SiteMapPath、 菜单和树视图控件。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-112">Once defined, the site map data can be accessed programmatically through the [`SiteMap` class](https://msdn.microsoft.com/library/system.web.sitemap.aspx) in the [`System.Web` namespace](https://msdn.microsoft.com/library/system.web.aspx) or through a variety of navigation Web controls, such as the SiteMapPath, Menu, and TreeView controls.</span></span> <span data-ttu-id="9b8c4-113">使用站点映射系统[提供程序模型](http://aspnet.4guysfromrolla.com/articles/101905-1.aspx)，以便可以创建不同的站点映射的序列化实现，并将其插入到 web 应用程序。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-113">The site map system uses the [provider model](http://aspnet.4guysfromrolla.com/articles/101905-1.aspx) so that different site map serialization implementations can be created and plugged into a web application.</span></span> <span data-ttu-id="9b8c4-114">默认站点映射提供程序使用 ASP.NET 2.0 随附仍然存在站点地图结构中的 XML 文件。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-114">The default site map provider that ships with ASP.NET 2.0 persists site map structure in an XML file.</span></span> <span data-ttu-id="9b8c4-115">回到[母版页和站点导航](../introduction/master-pages-and-site-navigation-cs.md)教程中，我们创建一个名为文件`Web.sitemap`，包含此结构中，并且具有与每个新的教程部分已更新其 XML。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-115">Back in the [Master Pages and Site Navigation](../introduction/master-pages-and-site-navigation-cs.md) tutorial we created a file named `Web.sitemap` that contained this structure and have been updating its XML with each new tutorial section.</span></span>

<span data-ttu-id="9b8c4-116">默认的基于 XML 的站点映射提供程序还适用于站点地图的结构是相当静态的如为这些教程。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-116">The default XML-based site map provider works well if the site map s structure is fairly static, such as for these tutorials.</span></span> <span data-ttu-id="9b8c4-117">在许多情况下，但是，更具动态站点地图需要。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-117">In many scenarios, however, a more dynamic site map is needed.</span></span> <span data-ttu-id="9b8c4-118">请考虑在图 1 中，每个类别和产品出现的位置为网站的结构中的一段所示的站点映射。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-118">Consider the site map shown in Figure 1, where each category and product appear as sections in the website s structure.</span></span> <span data-ttu-id="9b8c4-119">与此站点图中，访问与根节点相对应的 web 页面中可能会列出所有类别，而访问特定类别 s web 页面将列出该类别的产品和查看特定产品 s web 页面将显示该产品 s 详细信息。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-119">With this site map, visiting the web page corresponding to the root node might list all of the categories, whereas visiting a particular category s web page would list that category s products and viewing a particular product s web page would show that product s details.</span></span>


<span data-ttu-id="9b8c4-120">[![类别和产品构成站点地图的结构](building-a-custom-database-driven-site-map-provider-cs/_static/image1.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="9b8c4-120">[![The Categories and Products Makeup the Site Map s Structure](building-a-custom-database-driven-site-map-provider-cs/_static/image1.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image1.png)</span></span>

<span data-ttu-id="9b8c4-121">**图 1**: 类别和产品构成站点地图的结构 ([单击以查看实际尺寸的图像](building-a-custom-database-driven-site-map-provider-cs/_static/image2.png))</span><span class="sxs-lookup"><span data-stu-id="9b8c4-121">**Figure 1**: The Categories and Products Makeup the Site Map s Structure ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image2.png))</span></span>


<span data-ttu-id="9b8c4-122">虽然此基于类别和产品的结构可能是硬编码到`Web.sitemap`文件，该文件将需要一个类别时进行更新，或添加、 移除或重命名为产品。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-122">While this category- and product-based structure could be hard-coded into the `Web.sitemap` file, the file would need to be updated each time a category or product was added, removed, or renamed.</span></span> <span data-ttu-id="9b8c4-123">因此，站点映射维护会极大地简化如果从数据库或，理想情况下，业务逻辑层的应用程序 s 体系结构中检索到它的结构。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-123">Consequently, the site map maintenance would be greatly simplified if its structure was retrieved from the database or, ideally, from the Business Logic Layer of the application s architecture.</span></span> <span data-ttu-id="9b8c4-124">这样一来，如已添加产品和类别，请重命名或删除，站点图将自动更新以反映这些更改。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-124">That way, as products and categories were added, renamed, or deleted, the site map would automatically update to reflect these changes.</span></span>

<span data-ttu-id="9b8c4-125">由于 ASP.NET 2.0 的站点映射序列化提供程序模型之上构建，因此我们可以创建我们自己自定义站点地图提供程序获取其数据从备用数据存储，例如数据库或体系结构。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-125">Since ASP.NET 2.0 s site map serialization is built atop the provider model, we can create our own custom site map provider that grabs its data from an alternate data store, such as the database or architecture.</span></span> <span data-ttu-id="9b8c4-126">在本教程中我们将构建的自定义提供程序从 BLL 中检索其数据。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-126">In this tutorial we'll build a custom provider that retrieves its data from the BLL.</span></span> <span data-ttu-id="9b8c4-127">让我们来开始 ！</span><span class="sxs-lookup"><span data-stu-id="9b8c4-127">Let s get started!</span></span>

> [!NOTE]
> <span data-ttu-id="9b8c4-128">在本教程中创建的自定义站点映射提供程序紧密耦合到应用程序 s 体系结构和数据模型。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-128">The custom site map provider created in this tutorial is tightly coupled to the application s architecture and data model.</span></span> <span data-ttu-id="9b8c4-129">Jeff Prosise s[存储在 SQL Server 中的站点映射](https://msdn.microsoft.com/msdnmag/issues/05/06/WickedCode/)并[SQL 站点地图提供程序以前已等待](https://msdn.microsoft.com/msdnmag/issues/06/02/wickedcode/default.aspx)文章检查 SQL Server 中存储站点地图数据的通用的方法。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-129">Jeff Prosise s [Storing Site Maps in SQL Server](https://msdn.microsoft.com/msdnmag/issues/05/06/WickedCode/) and [The SQL Site Map Provider You ve Been Waiting For](https://msdn.microsoft.com/msdnmag/issues/06/02/wickedcode/default.aspx) articles examine a generalized approach to storing site map data in SQL Server.</span></span>


## <a name="step-1-creating-the-custom-site-map-provider-web-pages"></a><span data-ttu-id="9b8c4-130">步骤 1： 创建自定义站点映射提供程序 Web 页</span><span class="sxs-lookup"><span data-stu-id="9b8c4-130">Step 1: Creating the Custom Site Map Provider Web Pages</span></span>

<span data-ttu-id="9b8c4-131">我们开始创建自定义的站点地图提供程序之前，让我们来首先添加我们需要本教程中的 ASP.NET 页。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-131">Before we start creating a custom site map provider, let s first add the ASP.NET pages we'll need for this tutorial.</span></span> <span data-ttu-id="9b8c4-132">首先，通过添加一个名为的新文件夹`SiteMapProvider`。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-132">Start by adding a new folder named `SiteMapProvider`.</span></span> <span data-ttu-id="9b8c4-133">接下来，将以下 ASP.NET 页面添加到该文件夹，并确保将与每个页面相关联`Site.master`母版页：</span><span class="sxs-lookup"><span data-stu-id="9b8c4-133">Next, add the following ASP.NET pages to that folder, making sure to associate each page with the `Site.master` master page:</span></span>

- `Default.aspx`
- `ProductsByCategory.aspx`
- `ProductDetails.aspx`

<span data-ttu-id="9b8c4-134">此外将添加`CustomProviders`文件夹的子`App_Code`文件夹。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-134">Also add a `CustomProviders` subfolder to the `App_Code` folder.</span></span>


![将 ASP.NET 页面添加站点映射提供程序与相关的教程](building-a-custom-database-driven-site-map-provider-cs/_static/image2.gif)

<span data-ttu-id="9b8c4-136">**图 2**： 添加站点的 ASP.NET 页将映射与提供程序相关的教程</span><span class="sxs-lookup"><span data-stu-id="9b8c4-136">**Figure 2**: Add the ASP.NET Pages for the Site Map Provider-Related Tutorials</span></span>


<span data-ttu-id="9b8c4-137">由于没有为本部分中只有一个教程，我们不需要`Default.aspx`列出节的教程。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-137">Since there is only one tutorial for this section, we don t need `Default.aspx` to list the section s tutorials.</span></span> <span data-ttu-id="9b8c4-138">相反，`Default.aspx`将 GridView 控件中显示的类别。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-138">Instead, `Default.aspx` will display the categories in a GridView control.</span></span> <span data-ttu-id="9b8c4-139">我们将在步骤 2 中来解决此问题。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-139">We'll tackle this in Step 2.</span></span>

<span data-ttu-id="9b8c4-140">接下来，更新`Web.sitemap`包括对引用`Default.aspx`页。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-140">Next, update `Web.sitemap` to include a reference to the `Default.aspx` page.</span></span> <span data-ttu-id="9b8c4-141">具体而言，缓存后添加以下标记`<siteMapNode>`:</span><span class="sxs-lookup"><span data-stu-id="9b8c4-141">Specifically, add the following markup after the Caching `<siteMapNode>`:</span></span>


[!code-xml[Main](building-a-custom-database-driven-site-map-provider-cs/samples/sample1.xml)]

<span data-ttu-id="9b8c4-142">更新后`Web.sitemap`，花点时间查看通过浏览器网站的教程。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-142">After updating `Web.sitemap`, take a moment to view the tutorials website through a browser.</span></span> <span data-ttu-id="9b8c4-143">在左侧菜单现在包括唯一的站点映射提供程序教程所需的项。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-143">The menu on the left now includes an item for the sole site map provider tutorial.</span></span>


![站点图现在包含一个条目的站点映射提供程序教程](building-a-custom-database-driven-site-map-provider-cs/_static/image3.gif)

<span data-ttu-id="9b8c4-145">**图 3**： 站点图现在包含一个条目的站点映射提供程序教程</span><span class="sxs-lookup"><span data-stu-id="9b8c4-145">**Figure 3**: The Site Map Now Includes an Entry for the Site Map Provider Tutorial</span></span>


<span data-ttu-id="9b8c4-146">此教程 s 主要焦点是为了说明创建自定义的站点地图提供程序和 web 应用程序配置为使用该提供程序。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-146">This tutorial s main focus is to illustrate creating a custom site map provider and configuring a web application to use that provider.</span></span> <span data-ttu-id="9b8c4-147">具体而言，我们将构建的提供程序返回包括为每个类别和产品，节点以及一个根节点的站点映射，如下图中图 1 所示。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-147">In particular, we'll build a provider that returns a site map that includes a root node along with a node for each category and product, as depicted in Figure 1.</span></span> <span data-ttu-id="9b8c4-148">一般情况下，站点图的每个节点可能指定的 URL。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-148">In general, each node in the site map may specify a URL.</span></span> <span data-ttu-id="9b8c4-149">对于我们站点地图的根节点的 URL 将为`~/SiteMapProvider/Default.aspx`，这将列出所有数据库中的类别。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-149">For our site map, the root node s URL will be `~/SiteMapProvider/Default.aspx`, which will list all of the categories in the database.</span></span> <span data-ttu-id="9b8c4-150">站点地图中的每个类别节点将具有指向的 URL `~/SiteMapProvider/ProductsByCategory.aspx?CategoryID=categoryID`，这将列出在指定的产品的所有*categoryID*。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-150">Each category node in the site map will have a URL that points to `~/SiteMapProvider/ProductsByCategory.aspx?CategoryID=categoryID`, which will list all of the products in the specified *categoryID*.</span></span> <span data-ttu-id="9b8c4-151">最后，每个产品的站点地图节点将指向`~/SiteMapProvider/ProductDetails.aspx?ProductID=productID`，随后会显示特定产品 s 详细信息。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-151">Finally, each product site map node will point to `~/SiteMapProvider/ProductDetails.aspx?ProductID=productID`, which will display the specific product s details.</span></span>

<span data-ttu-id="9b8c4-152">若要开始我们需要创建`Default.aspx`， `ProductsByCategory.aspx`，和`ProductDetails.aspx`页。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-152">To start we need to create the `Default.aspx`, `ProductsByCategory.aspx`, and `ProductDetails.aspx` pages.</span></span> <span data-ttu-id="9b8c4-153">这些页面分别在步骤 2、 3 和 4 中完成。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-153">These pages are completed in Steps 2, 3, and 4, respectively.</span></span> <span data-ttu-id="9b8c4-154">由于本教程的主旨是位于在站点地图提供程序，并且由于过去教程已介绍如何创建报告的这种多页母版/详细信息，我们将一蹴而就完成步骤 2 至 4。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-154">Since the thrust of this tutorial is on site map providers, and since past tutorials have covered creating these sorts of multi-page master/detail reports, we will hurry through Steps 2 through 4.</span></span> <span data-ttu-id="9b8c4-155">如果你需要在创建跨越多个页面的母版/详细信息报表刷新程序，请返回到[母版/详细信息筛选跨两个页面](../masterdetail/master-detail-filtering-across-two-pages-cs.md)教程。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-155">If you need a refresher on creating master/detail reports that span multiple pages, refer back to the [Master/Detail Filtering Across Two Pages](../masterdetail/master-detail-filtering-across-two-pages-cs.md) tutorial.</span></span>

## <a name="step-2-displaying-a-list-of-categories"></a><span data-ttu-id="9b8c4-156">步骤 2： 显示类别的列表</span><span class="sxs-lookup"><span data-stu-id="9b8c4-156">Step 2: Displaying a List of Categories</span></span>

<span data-ttu-id="9b8c4-157">打开`Default.aspx`页中`SiteMapProvider`文件夹，然后拖动 GridView 从工具箱拖到设计器中，设置其`ID`到`Categories`。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-157">Open the `Default.aspx` page in the `SiteMapProvider` folder and drag a GridView from the Toolbox onto the Designer, setting its `ID` to `Categories`.</span></span> <span data-ttu-id="9b8c4-158">从 GridView s 智能标记，请将其绑定到名为新 ObjectDataSource`CategoriesDataSource`并将其配置，以便它将检索其数据使用`CategoriesBLL`类的`GetCategories`方法。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-158">From the GridView s smart tag, bind it to a new ObjectDataSource named `CategoriesDataSource` and configure it so that it retrieves its data using the `CategoriesBLL` class s `GetCategories` method.</span></span> <span data-ttu-id="9b8c4-159">由于此 GridView 只显示类别，并且不提供数据修改功能，设置下拉列表中插入、 更新和删除选项卡添加到 （无）。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-159">Since this GridView just displays the categories and does not provide data modification capabilities, set the drop-down lists in the UPDATE, INSERT, and DELETE tabs to (None) .</span></span>


<span data-ttu-id="9b8c4-160">[![配置对象数据源返回类别使用 GetCategories 方法](building-a-custom-database-driven-site-map-provider-cs/_static/image4.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="9b8c4-160">[![Configure the ObjectDataSource to Return Categories Using the GetCategories Method](building-a-custom-database-driven-site-map-provider-cs/_static/image4.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image3.png)</span></span>

<span data-ttu-id="9b8c4-161">**图 4**： 配置到返回类别使用 ObjectDataSource`GetCategories`方法 ([单击以查看实际尺寸的图像](building-a-custom-database-driven-site-map-provider-cs/_static/image4.png))</span><span class="sxs-lookup"><span data-stu-id="9b8c4-161">**Figure 4**: Configure the ObjectDataSource to Return Categories Using the `GetCategories` Method ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image4.png))</span></span>


<span data-ttu-id="9b8c4-162">[![设置下拉列表中插入、 更新和删除选项卡为 （无）](building-a-custom-database-driven-site-map-provider-cs/_static/image5.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="9b8c4-162">[![Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None)](building-a-custom-database-driven-site-map-provider-cs/_static/image5.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image5.png)</span></span>

<span data-ttu-id="9b8c4-163">**图 5**： 设置下拉列表列出了在更新、 插入和删除选项卡中为 （无） ([单击以查看实际尺寸的图像](building-a-custom-database-driven-site-map-provider-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="9b8c4-163">**Figure 5**: Set the Drop-Down Lists in the UPDATE, INSERT, and DELETE Tabs to (None) ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image6.png))</span></span>


<span data-ttu-id="9b8c4-164">完成配置数据源向导后，Visual Studio 将添加为 BoundField `CategoryID`， `CategoryName`， `Description`， `NumberOfProducts`，和`BrochurePath`。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-164">After completing the Configure Data Source wizard, Visual Studio will add a BoundField for `CategoryID`, `CategoryName`, `Description`, `NumberOfProducts`, and `BrochurePath`.</span></span> <span data-ttu-id="9b8c4-165">编辑，使其仅包含 GridView`CategoryName`并`Description`BoundFields 和更新`CategoryName`BoundField 的`HeaderText`类别的属性。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-165">Edit the GridView so that it only contains the `CategoryName` and `Description` BoundFields and update the `CategoryName` BoundField s `HeaderText` property to Category .</span></span>

<span data-ttu-id="9b8c4-166">接下来，添加 HyperLinkField 并因此放置其 s 最左侧的字段。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-166">Next, add a HyperLinkField and position it so that it s the left-most field.</span></span> <span data-ttu-id="9b8c4-167">设置`DataNavigateUrlFields`属性设置为`CategoryID`并`DataNavigateUrlFormatString`属性设置为`~/SiteMapProvider/ProductsByCategory.aspx?CategoryID={0}`。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-167">Set the `DataNavigateUrlFields` property to `CategoryID` and the `DataNavigateUrlFormatString` property to `~/SiteMapProvider/ProductsByCategory.aspx?CategoryID={0}`.</span></span> <span data-ttu-id="9b8c4-168">设置`Text`查看产品的属性。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-168">Set the `Text` property to View Products .</span></span>


![将 HyperLinkField 添加到类别 GridView](building-a-custom-database-driven-site-map-provider-cs/_static/image6.gif)

<span data-ttu-id="9b8c4-170">**图 6**： 添加到 HyperLinkField `Categories` GridView</span><span class="sxs-lookup"><span data-stu-id="9b8c4-170">**Figure 6**: Add a HyperLinkField to the `Categories` GridView</span></span>


<span data-ttu-id="9b8c4-171">创建 ObjectDataSource 和自定义 GridView 的字段后, 两个控件声明性标记将如下所示：</span><span class="sxs-lookup"><span data-stu-id="9b8c4-171">After creating the ObjectDataSource and customizing the GridView s fields, the two controls declarative markup will look like the following:</span></span>


[!code-aspx[Main](building-a-custom-database-driven-site-map-provider-cs/samples/sample2.aspx)]

<span data-ttu-id="9b8c4-172">图 7 显示了`Default.aspx`时的浏览器查看。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-172">Figure 7 shows `Default.aspx` when viewed through a browser.</span></span> <span data-ttu-id="9b8c4-173">单击类别的查看产品链接将你带到`ProductsByCategory.aspx?CategoryID=categoryID`，其在步骤 3 中，我们将生成。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-173">Clicking a category s View Products link takes you to `ProductsByCategory.aspx?CategoryID=categoryID`, which we will build in Step 3.</span></span>


<span data-ttu-id="9b8c4-174">[![每个类别是列出沿与视图产品链接](building-a-custom-database-driven-site-map-provider-cs/_static/image7.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="9b8c4-174">[![Each Category is Listed Along with a View Products Link](building-a-custom-database-driven-site-map-provider-cs/_static/image7.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image7.png)</span></span>

<span data-ttu-id="9b8c4-175">**图 7**： 列出沿与视图产品链接为每个类别 ([单击以查看实际尺寸的图像](building-a-custom-database-driven-site-map-provider-cs/_static/image8.png))</span><span class="sxs-lookup"><span data-stu-id="9b8c4-175">**Figure 7**: Each Category is Listed Along with a View Products Link ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image8.png))</span></span>


## <a name="step-3-listing-the-selected-category-s-products"></a><span data-ttu-id="9b8c4-176">步骤 3： 列出所选的类别的产品</span><span class="sxs-lookup"><span data-stu-id="9b8c4-176">Step 3: Listing the Selected Category s Products</span></span>

<span data-ttu-id="9b8c4-177">打开`ProductsByCategory.aspx`页上，添加一个 GridView，其命名为`ProductsByCategory`。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-177">Open the `ProductsByCategory.aspx` page and add a GridView, naming it `ProductsByCategory`.</span></span> <span data-ttu-id="9b8c4-178">从其智能标记将 GridView 绑定到名为新 ObjectDataSource `ProductsByCategoryDataSource`。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-178">From its smart tag, bind the GridView to a new ObjectDataSource named `ProductsByCategoryDataSource`.</span></span> <span data-ttu-id="9b8c4-179">配置要使用 ObjectDataSource`ProductsBLL`类的`GetProductsByCategoryID(categoryID)`方法，设置下拉列表中的更新、 插入和删除选项卡为 （无） 列表。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-179">Configure the ObjectDataSource to use the `ProductsBLL` class s `GetProductsByCategoryID(categoryID)` method and set the drop-down lists to (None) in the UPDATE, INSERT, and DELETE tabs.</span></span>


<span data-ttu-id="9b8c4-180">[![使用 ProductsBLL 类的 GetProductsByCategoryID(categoryID) 方法](building-a-custom-database-driven-site-map-provider-cs/_static/image8.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="9b8c4-180">[![Use the ProductsBLL Class s GetProductsByCategoryID(categoryID) Method](building-a-custom-database-driven-site-map-provider-cs/_static/image8.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image9.png)</span></span>

<span data-ttu-id="9b8c4-181">**图 8**： 使用`ProductsBLL`类 s`GetProductsByCategoryID(categoryID)`方法 ([单击以查看实际尺寸的图像](building-a-custom-database-driven-site-map-provider-cs/_static/image10.png))</span><span class="sxs-lookup"><span data-stu-id="9b8c4-181">**Figure 8**: Use the `ProductsBLL` Class s `GetProductsByCategoryID(categoryID)` Method ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image10.png))</span></span>


<span data-ttu-id="9b8c4-182">配置数据源向导的最后一步会提示输入参数源*categoryID*。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-182">The final step in the Configure Data Source wizard prompts for a parameter source for *categoryID*.</span></span> <span data-ttu-id="9b8c4-183">因为此信息将通过查询字符串字段`CategoryID`、 从下拉列表中选择查询字符串和 QueryStringField 文本框中输入类别 id，如图 9 中所示。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-183">Since this information is passed through the querystring field `CategoryID`, select QueryString from the drop-down list and enter CategoryID in the QueryStringField textbox as shown in Figure 9.</span></span> <span data-ttu-id="9b8c4-184">单击完成以完成向导。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-184">Click Finish to complete the wizard.</span></span>


<span data-ttu-id="9b8c4-185">[![使用 CategoryID 查询字符串字段的 categoryID 参数](building-a-custom-database-driven-site-map-provider-cs/_static/image9.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="9b8c4-185">[![Use the CategoryID Querystring Field for the categoryID Parameter](building-a-custom-database-driven-site-map-provider-cs/_static/image9.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image11.png)</span></span>

<span data-ttu-id="9b8c4-186">**图 9**： 使用`CategoryID`查询字符串字段*categoryID*参数 ([单击以查看实际尺寸的图像](building-a-custom-database-driven-site-map-provider-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="9b8c4-186">**Figure 9**: Use the `CategoryID` Querystring Field for the *categoryID* Parameter ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image12.png))</span></span>


<span data-ttu-id="9b8c4-187">完成向导后，Visual Studio 将添加相应 BoundFields 和 CheckBoxField 到产品数据字段的 GridView。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-187">After completing the wizard, Visual Studio will add corresponding BoundFields and a CheckBoxField to the GridView for the product data fields.</span></span> <span data-ttu-id="9b8c4-188">删除所有除`ProductName`， `UnitPrice`，和`SupplierName`BoundFields。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-188">Remove all but the `ProductName`, `UnitPrice`, and `SupplierName` BoundFields.</span></span> <span data-ttu-id="9b8c4-189">自定义以下三个 BoundFields`HeaderText`属性分别读取产品、 价格和供应商。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-189">Customize these three BoundFields `HeaderText` properties to read Product, Price, and Supplier, respectively.</span></span> <span data-ttu-id="9b8c4-190">格式`UnitPrice`BoundField 作为一种货币。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-190">Format the `UnitPrice` BoundField as a currency.</span></span>

<span data-ttu-id="9b8c4-191">接下来，添加 HyperLinkField 并将其移动到的最左边的位置。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-191">Next, add a HyperLinkField and move it to the left-most position.</span></span> <span data-ttu-id="9b8c4-192">设置其`Text`属性设置为视图的详细信息，其`DataNavigateUrlFields`属性设置为`ProductID`，并将其`DataNavigateUrlFormatString`属性设置为`~/SiteMapProvider/ProductDetails.aspx?ProductID={0}`。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-192">Set its `Text` property to View Details, its `DataNavigateUrlFields` property to `ProductID`, and its `DataNavigateUrlFormatString` property to `~/SiteMapProvider/ProductDetails.aspx?ProductID={0}`.</span></span>


![添加指向 ProductDetails.aspx 视图的详细信息 HyperLinkField](building-a-custom-database-driven-site-map-provider-cs/_static/image10.gif)

<span data-ttu-id="9b8c4-194">**图 10**： 添加视图详细信息指向 HyperLinkField `ProductDetails.aspx`</span><span class="sxs-lookup"><span data-stu-id="9b8c4-194">**Figure 10**: Add a View Details HyperLinkField that Points to `ProductDetails.aspx`</span></span>


<span data-ttu-id="9b8c4-195">进行这些自定义之后, 的 GridView 和 ObjectDataSource s 声明性标记应如下所示：</span><span class="sxs-lookup"><span data-stu-id="9b8c4-195">After making these customizations, the GridView and ObjectDataSource s declarative markup should resemble the following:</span></span>


[!code-aspx[Main](building-a-custom-database-driven-site-map-provider-cs/samples/sample3.aspx)]

<span data-ttu-id="9b8c4-196">返回到查看`Default.aspx`通过浏览器和查看产品上的单击链接饮料对应的。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-196">Return to viewing `Default.aspx` through a browser and click on the View Products link for Beverages.</span></span> <span data-ttu-id="9b8c4-197">这会转到`ProductsByCategory.aspx?CategoryID=1`，Northwind 数据库属于饮料类别中显示名称、 价格和产品的供应商 （请参阅图 11）。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-197">This will take you to `ProductsByCategory.aspx?CategoryID=1`, displaying the names, prices, and suppliers of the products in the Northwind database that belong to the Beverages category (see Figure 11).</span></span> <span data-ttu-id="9b8c4-198">可随意进一步增强此页以包含将其返回到类别列表页的用户的链接 (`Default.aspx`) 和 detailsview FormView 控件显示所选的类别的名称和说明。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-198">Feel free to further enhance this page to include a link to return users to the category listing page (`Default.aspx`) and a DetailsView or FormView control that displays the selected category s name and description.</span></span>


<span data-ttu-id="9b8c4-199">[![显示饮料名称、 价格和供应商](building-a-custom-database-driven-site-map-provider-cs/_static/image11.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="9b8c4-199">[![The Beverages Names, Prices, and Suppliers are Displayed](building-a-custom-database-driven-site-map-provider-cs/_static/image11.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image13.png)</span></span>

<span data-ttu-id="9b8c4-200">**图 11**： 显示饮料名称、 价格和供应商 ([单击以查看实际尺寸的图像](building-a-custom-database-driven-site-map-provider-cs/_static/image14.png))</span><span class="sxs-lookup"><span data-stu-id="9b8c4-200">**Figure 11**: The Beverages Names, Prices, and Suppliers are Displayed ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image14.png))</span></span>


## <a name="step-4-showing-a-product-s-details"></a><span data-ttu-id="9b8c4-201">步骤 4： 显示产品 s 详细信息</span><span class="sxs-lookup"><span data-stu-id="9b8c4-201">Step 4: Showing a Product s Details</span></span>

<span data-ttu-id="9b8c4-202">最后一页， `ProductDetails.aspx`，显示所选的产品的详细信息。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-202">The final page, `ProductDetails.aspx`, displays the selected products details.</span></span> <span data-ttu-id="9b8c4-203">打开`ProductDetails.aspx`并从工具箱拖动到设计器中拖动 DetailsView。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-203">Open `ProductDetails.aspx` and drag a DetailsView from the Toolbox onto the Designer.</span></span> <span data-ttu-id="9b8c4-204">设置 DetailsView s`ID`属性设置为`ProductInfo`并将清除其`Height`和`Width`属性值。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-204">Set the DetailsView s `ID` property to `ProductInfo` and clear out its `Height` and `Width` property values.</span></span> <span data-ttu-id="9b8c4-205">从其智能标记将 DetailsView 绑定到名为新 ObjectDataSource `ProductDataSource`，配置将从其数据 ObjectDataSource`ProductsBLL`类的`GetProductByProductID(productID)`方法。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-205">From its smart tag, bind the DetailsView to a new ObjectDataSource named `ProductDataSource`, configuring the ObjectDataSource to pull its data from the `ProductsBLL` class s `GetProductByProductID(productID)` method.</span></span> <span data-ttu-id="9b8c4-206">如步骤 2 和 3 中创建的上一个网页，设置下拉列表中插入、 更新和删除选项卡添加到 （无）。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-206">As with the previous web pages created in Steps 2 and 3, set the drop-down lists in the UPDATE, INSERT, and DELETE tabs to (None) .</span></span>


<span data-ttu-id="9b8c4-207">[![配置对象数据源使用 GetProductByProductID(productID) 方法](building-a-custom-database-driven-site-map-provider-cs/_static/image12.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="9b8c4-207">[![Configure the ObjectDataSource to Use the GetProductByProductID(productID) Method](building-a-custom-database-driven-site-map-provider-cs/_static/image12.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image15.png)</span></span>

<span data-ttu-id="9b8c4-208">**图 12**： 配置为使用 ObjectDataSource`GetProductByProductID(productID)`方法 ([单击以查看实际尺寸的图像](building-a-custom-database-driven-site-map-provider-cs/_static/image16.png))</span><span class="sxs-lookup"><span data-stu-id="9b8c4-208">**Figure 12**: Configure the ObjectDataSource to Use the `GetProductByProductID(productID)` Method ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image16.png))</span></span>


<span data-ttu-id="9b8c4-209">配置数据源向导的最后一步会提示输入的源*productID*参数。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-209">The last step of the Configure Data Source wizard prompts for the source of the *productID* parameter.</span></span> <span data-ttu-id="9b8c4-210">因为这些数据包括通过查询字符串字段`ProductID`，将下拉列表设置为查询字符串和到 ProductID QueryStringField 文本框。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-210">Since this data comes through the querystring field `ProductID`, set the drop-down list to QueryString and the QueryStringField textbox to ProductID.</span></span> <span data-ttu-id="9b8c4-211">最后，单击完成按钮以完成向导。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-211">Finally, click the Finish button to complete the wizard.</span></span>


<span data-ttu-id="9b8c4-212">[![配置产品 id 参数，以从产品 id 查询字符串字段中提取其值](building-a-custom-database-driven-site-map-provider-cs/_static/image13.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="9b8c4-212">[![Configure the productID Parameter to Pull its Value from the ProductID Querystring Field](building-a-custom-database-driven-site-map-provider-cs/_static/image13.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image17.png)</span></span>

<span data-ttu-id="9b8c4-213">**图 13**： 配置*productID*参数来提取其值从`ProductID`查询字符串字段 ([单击以查看实际尺寸的图像](building-a-custom-database-driven-site-map-provider-cs/_static/image18.png))</span><span class="sxs-lookup"><span data-stu-id="9b8c4-213">**Figure 13**: Configure the *productID* Parameter to Pull its Value from the `ProductID` Querystring Field ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image18.png))</span></span>


<span data-ttu-id="9b8c4-214">完成配置数据源向导后，Visual Studio 将创建相应 BoundFields 和 CheckBoxField 产品数据字段的 DetailsView 中。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-214">After completing the Configure Data Source wizard, Visual Studio will create corresponding BoundFields and a CheckBoxField in the DetailsView for the product data fields.</span></span> <span data-ttu-id="9b8c4-215">删除`ProductID`， `SupplierID`，和`CategoryID`BoundFields 并根据需要配置剩余的字段。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-215">Remove the `ProductID`, `SupplierID`, and `CategoryID` BoundFields and configure the remaining fields as you see fit.</span></span> <span data-ttu-id="9b8c4-216">少量的美观的配置之后, 我 DetailsView 和 ObjectDataSource s 的声明性标记看起来如下所示：</span><span class="sxs-lookup"><span data-stu-id="9b8c4-216">After a handful of aesthetic configurations, my DetailsView and ObjectDataSource s declarative markup looked like the following:</span></span>


[!code-aspx[Main](building-a-custom-database-driven-site-map-provider-cs/samples/sample4.aspx)]

<span data-ttu-id="9b8c4-217">若要测试此页，请返回到`Default.aspx`然后单击查看产品的饮料类别。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-217">To test this page, return to `Default.aspx` and click on View Products for the Beverages category.</span></span> <span data-ttu-id="9b8c4-218">从饮料产品列表中，单击 Chai 茶的查看详细信息链接。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-218">From the listing of beverage products, click on the View Details link for Chai Tea.</span></span> <span data-ttu-id="9b8c4-219">这会转到`ProductDetails.aspx?ProductID=1`，其中显示 Chai 茶 s （请参阅图 14） 的详细信息。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-219">This will take you to `ProductDetails.aspx?ProductID=1`, which shows a Chai Tea s details (see Figure 14).</span></span>


<span data-ttu-id="9b8c4-220">[![显示 Chai 茶 s 供应商、 类别、 价格和其他信息](building-a-custom-database-driven-site-map-provider-cs/_static/image14.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="9b8c4-220">[![Chai Tea s Supplier, Category, Price, and Other Information is Displayed](building-a-custom-database-driven-site-map-provider-cs/_static/image14.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image19.png)</span></span>

<span data-ttu-id="9b8c4-221">**图 14**： 显示 Chai 茶 s 供应商、 类别、 价格和其他信息 ([单击以查看实际尺寸的图像](building-a-custom-database-driven-site-map-provider-cs/_static/image20.png))</span><span class="sxs-lookup"><span data-stu-id="9b8c4-221">**Figure 14**: Chai Tea s Supplier, Category, Price, and Other Information is Displayed ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image20.png))</span></span>


## <a name="step-5-understanding-the-inner-workings-of-a-site-map-provider"></a><span data-ttu-id="9b8c4-222">步骤 5： 了解站点地图提供程序的内部工作机制</span><span class="sxs-lookup"><span data-stu-id="9b8c4-222">Step 5: Understanding the Inner Workings of a Site Map Provider</span></span>

<span data-ttu-id="9b8c4-223">站点图在 web 服务器的内存中表示为一系列`SiteMapNode`构成了层次结构的实例。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-223">The site map is represented in the web server s memory as a collection of `SiteMapNode` instances that form a hierarchy.</span></span> <span data-ttu-id="9b8c4-224">必须有且只有一个根、 所有非根节点必须有且只有一个父节点，和的所有节点可能都包含任意数目的子级。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-224">There must be exactly one root, all non-root nodes must have exactly one parent node, and all nodes may have an arbitrary number of children.</span></span> <span data-ttu-id="9b8c4-225">每个`SiteMapNode`对象表示网站的结构中的某个部分; 这些部分通常具有相应的 web 页。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-225">Each `SiteMapNode` object represents a section in the website s structure; these sections commonly have a corresponding web page.</span></span> <span data-ttu-id="9b8c4-226">因此， [ `SiteMapNode`类](https://msdn.microsoft.com/library/system.web.sitemapnode.aspx)具有属性，如`Title`， `Url`，和`Description`，其中介绍的部分`SiteMapNode`表示。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-226">Consequently, the [`SiteMapNode` class](https://msdn.microsoft.com/library/system.web.sitemapnode.aspx) has properties like `Title`, `Url`, and `Description`, which provide information for the section the `SiteMapNode` represents.</span></span> <span data-ttu-id="9b8c4-227">此外，还有`Key`属性，用于唯一地标识每个`SiteMapNode`中的层次结构，以及用来建立此层次结构的属性`ChildNodes`， `ParentNode`， `NextSibling`， `PreviousSibling`，依次类推。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-227">There is also a `Key` property that uniquely identifies each `SiteMapNode` in the hierarchy, as well as properties used to establish this hierarchy `ChildNodes`, `ParentNode`, `NextSibling`, `PreviousSibling`, and so forth.</span></span>

<span data-ttu-id="9b8c4-228">图 15 显示了常规的站点地图结构，来自图 1 中，但具有更精细地草绘的实现详细信息。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-228">Figure 15 shows the general site map structure from Figure 1, but with the implementation details sketched out in finer detail.</span></span>


<span data-ttu-id="9b8c4-229">[![每个 SiteMapNode 具有属性如标题、 Url、 密钥等等](building-a-custom-database-driven-site-map-provider-cs/_static/image16.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image15.gif)</span><span class="sxs-lookup"><span data-stu-id="9b8c4-229">[![Each SiteMapNode has Properties Like Title, Url, Key, and So On](building-a-custom-database-driven-site-map-provider-cs/_static/image16.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image15.gif)</span></span>

<span data-ttu-id="9b8c4-230">**图 15**： 每个`SiteMapNode`都有一些属性例如`Title`， `Url`，`Key`等 ([单击以查看实际尺寸的图像](building-a-custom-database-driven-site-map-provider-cs/_static/image17.gif))</span><span class="sxs-lookup"><span data-stu-id="9b8c4-230">**Figure 15**: Each `SiteMapNode` has Properties Like `Title`, `Url`, `Key`, and So On ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image17.gif))</span></span>


<span data-ttu-id="9b8c4-231">站点图是可通过访问[`SiteMap`类](https://msdn.microsoft.com/library/system.web.sitemap.aspx)中[`System.Web`命名空间](https://msdn.microsoft.com/library/system.web.aspx)。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-231">The site map is accessible through the [`SiteMap` class](https://msdn.microsoft.com/library/system.web.sitemap.aspx) in the [`System.Web` namespace](https://msdn.microsoft.com/library/system.web.aspx).</span></span> <span data-ttu-id="9b8c4-232">此类 s`RootNode`属性返回的站点映射的根目录`SiteMapNode`实例;`CurrentNode`将返回`SiteMapNode`其`Url`属性与当前请求页的 URL 匹配。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-232">This class s `RootNode` property returns the site map s root `SiteMapNode` instance; `CurrentNode` returns the `SiteMapNode` whose `Url` property matches the URL of the currently requested page.</span></span> <span data-ttu-id="9b8c4-233">ASP.NET 2.0 的导航 Web 控件在内部使用此类。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-233">This class is used internally by ASP.NET 2.0 s navigation Web controls.</span></span>

<span data-ttu-id="9b8c4-234">当`SiteMap`的类属性进行访问，它必须序列从一些持久介质站点地图结构化到内存中。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-234">When the `SiteMap` class s properties are accessed, it must serialize the site map structure from some persistent medium into memory.</span></span> <span data-ttu-id="9b8c4-235">但是，站点映射的序列化逻辑不是硬编码到`SiteMap`类。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-235">However, the site map serialization logic is not hard coded into the `SiteMap` class.</span></span> <span data-ttu-id="9b8c4-236">相反，在运行时`SiteMap`类确定哪些站点图*提供程序*用于序列化。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-236">Instead, at runtime the `SiteMap` class determines which site map *provider* to use for serialization.</span></span> <span data-ttu-id="9b8c4-237">默认情况下[`XmlSiteMapProvider`类](https://msdn.microsoft.com/library/system.web.xmlsitemapprovider.aspx)使用时，这从格式正确的 XML 文件中读取站点地图的结构。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-237">By default, the [`XmlSiteMapProvider` class](https://msdn.microsoft.com/library/system.web.xmlsitemapprovider.aspx) is used, which reads the site map s structure from a properly-formatted XML file.</span></span> <span data-ttu-id="9b8c4-238">但是，很少的工作与我们可以创建我们自己自定义站点地图提供程序。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-238">However, with a little bit of work we can create our own custom site map provider.</span></span>

<span data-ttu-id="9b8c4-239">所有站点地图提供程序必须都派生自[`SiteMapProvider`类](https://msdn.microsoft.com/library/system.web.sitemapprovider.aspx)，其中包括基本的方法和属性所需的站点映射提供程序，但省略的许多实现细节。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-239">All site map providers must be derived from the [`SiteMapProvider` class](https://msdn.microsoft.com/library/system.web.sitemapprovider.aspx), which includes the essential methods and properties needed for site map providers, but omits many of the implementation details.</span></span> <span data-ttu-id="9b8c4-240">第二个类的[ `StaticSiteMapProvider` ](https://msdn.microsoft.com/library/system.web.staticsitemapprovider.aspx)，扩展了`SiteMapProvider`类，其中包含所需的功能的更可靠的实现。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-240">A second class, [`StaticSiteMapProvider`](https://msdn.microsoft.com/library/system.web.staticsitemapprovider.aspx), extends the `SiteMapProvider` class and contains a more robust implementation of the needed functionality.</span></span> <span data-ttu-id="9b8c4-241">在内部，`StaticSiteMapProvider`存储`SiteMapNode`实例的站点中的映射`Hashtable`，并提供等方法`AddNode(child, parent)`，`RemoveNode(siteMapNode),`和`Clear()`的添加和删除`SiteMapNode`到内部 s `Hashtable`。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-241">Internally, the `StaticSiteMapProvider` stores the `SiteMapNode` instances of the site map in a `Hashtable` and provides methods like `AddNode(child, parent)`, `RemoveNode(siteMapNode),` and `Clear()` that add and remove `SiteMapNode` s to the internal `Hashtable`.</span></span> <span data-ttu-id="9b8c4-242">`XmlSiteMapProvider` 派生自 `StaticSiteMapProvider`。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-242">`XmlSiteMapProvider` is derived from `StaticSiteMapProvider`.</span></span>

<span data-ttu-id="9b8c4-243">当创建自定义的站点地图提供程序扩展了`StaticSiteMapProvider`，必须重写的两种抽象方法： [ `BuildSiteMap` ](https://msdn.microsoft.com/library/system.web.staticsitemapprovider.buildsitemap.aspx)并[ `GetRootNodeCore` ](https://msdn.microsoft.com/library/system.web.sitemapprovider.getrootnodecore.aspx)。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-243">When creating a custom site map provider that extends `StaticSiteMapProvider`, there are two abstract methods that must be overridden: [`BuildSiteMap`](https://msdn.microsoft.com/library/system.web.staticsitemapprovider.buildsitemap.aspx) and [`GetRootNodeCore`](https://msdn.microsoft.com/library/system.web.sitemapprovider.getrootnodecore.aspx).</span></span> <span data-ttu-id="9b8c4-244">`BuildSiteMap`正如其名，负责从持久性存储区加载站点地图结构和构造内存中。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-244">`BuildSiteMap`, as its name implies, is responsible for loading the site map structure from persistent storage and constructing it in memory.</span></span> <span data-ttu-id="9b8c4-245">`GetRootNodeCore` 在站点地图中返回的根节点。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-245">`GetRootNodeCore` returns the root node in the site map.</span></span>

<span data-ttu-id="9b8c4-246">前一个 web 应用程序可以使用它必须在应用程序配置中注册站点映射提供程序。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-246">Before a web application can use a site map provider it must be registered in the application s configuration.</span></span> <span data-ttu-id="9b8c4-247">默认情况下`XmlSiteMapProvider`类使用的名称注册`AspNetXmlSiteMapProvider`。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-247">By default, the `XmlSiteMapProvider` class is registered using the name `AspNetXmlSiteMapProvider`.</span></span> <span data-ttu-id="9b8c4-248">若要注册其他站点地图提供程序，添加以下标记到`Web.config`:</span><span class="sxs-lookup"><span data-stu-id="9b8c4-248">To register additional site map providers, add the following markup to `Web.config`:</span></span>


[!code-xml[Main](building-a-custom-database-driven-site-map-provider-cs/samples/sample5.xml)]

<span data-ttu-id="9b8c4-249">*名称*值为指定用户可读名称时提供程序*类型*指定站点地图提供程序的完全限定类型名称。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-249">The *name* value assigns a human-readable name to the provider while *type* specifies the fully-qualified type name of the site map provider.</span></span> <span data-ttu-id="9b8c4-250">我们将探讨的具体值的*名称*并*类型*在步骤 7 中的值后，我们制作了我们自定义站点地图提供程序。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-250">We'll explore concrete values for the *name* and *type* values in Step 7, after we ve created our custom site map provider.</span></span>

<span data-ttu-id="9b8c4-251">站点映射提供程序类实例化第一次从访问`SiteMap`类并且保持在内存中为 web 应用程序的生存期。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-251">The site map provider class is instantiated the first time it is accessed from the `SiteMap` class and remains in memory for the lifetime of the web application.</span></span> <span data-ttu-id="9b8c4-252">由于没有站点地图提供程序，可能从多个并发网站访问者调用的一个实例，它是命令性提供程序的方法将*线程安全*。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-252">Since there is only one instance of the site map provider that may be invoked from multiple, concurrent web site visitors, it is imperative that the provider s methods be *thread-safe*.</span></span>

<span data-ttu-id="9b8c4-253">出于性能和可伸缩性原因，它非常重要，我们在缓存在内存中的站点映射结构并将返回此缓存的结构，而不是无需重新创建每次`BuildSiteMap`调用方法。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-253">For performance and scalability reasons, it s important that we cache the in-memory site map structure and return this cached structure rather than recreating it every time the `BuildSiteMap` method is invoked.</span></span> <span data-ttu-id="9b8c4-254">`BuildSiteMap` 不能调用多次，每个页请求，每个用户，具体取决于页和站点地图结构的深度中使用导航控件。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-254">`BuildSiteMap` may be called several times per page request per user, depending on the navigation controls in use on the page and the depth of the site map structure.</span></span> <span data-ttu-id="9b8c4-255">在任何情况下，如果我们不会缓存在站点地图结构`BuildSiteMap`每次调用它时我们将需要重新检索已从 （这将在查询中对数据库产生） 的体系结构的产品和类别信息。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-255">In any case, if we do not cache the site map structure in `BuildSiteMap` then each time it is invoked we would need to re-retrieve the product and category information from the architecture (which would result in a query to the database).</span></span> <span data-ttu-id="9b8c4-256">如我们在前面的缓存教程所述，缓存的数据可能会失效。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-256">As we discussed in the previous caching tutorials, cached data can become stale.</span></span> <span data-ttu-id="9b8c4-257">若要应对这种情况，我们可以使用时间-或 SQL 缓存依赖项基于满。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-257">To combat this, we can use either time- or SQL cache dependency-based expiries.</span></span>

> [!NOTE]
> <span data-ttu-id="9b8c4-258">站点地图提供程序可能会根据需要重写[`Initialize`方法](https://msdn.microsoft.com/library/system.web.sitemapprovider.initialize.aspx)。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-258">A site map provider may optionally override the [`Initialize` method](https://msdn.microsoft.com/library/system.web.sitemapprovider.initialize.aspx).</span></span> <span data-ttu-id="9b8c4-259">`Initialize` 站点地图提供程序首次实例化并传递任何自定义属性分配给中的提供程序时调用`Web.config`中`<add>`元素一样的元素： `<add name="name" type="type" customAttribute="value" />`。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-259">`Initialize` is invoked when the site map provider is first instantiated and is passed any custom attributes assigned to the provider in `Web.config` in the `<add>` element like: `<add name="name" type="type" customAttribute="value" />`.</span></span> <span data-ttu-id="9b8c4-260">如果你想要允许页面开发人员可以指定各种站点映射提供程序相关设置，而无需修改提供程序的代码，它非常有用。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-260">It is useful if you want to allow a page developer to specify various site map provider-related settings without having to modify the provider s code.</span></span> <span data-ttu-id="9b8c4-261">例如，如果我们已读取的类别和产品数据直接从数据库而不是通过体系结构，d 我们可能想要让页面开发人员指定数据库连接字符串通过`Web.config`而不是使用硬编码提供程序的代码中的值。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-261">For example, if we were reading the category and products data directly from the database as opposed to through the architecture, we d likely want to let the page developer specify the database connection string through `Web.config` rather than using a hard coded value in the provider s code.</span></span> <span data-ttu-id="9b8c4-262">第 6 步中，我们将构建的自定义站点映射提供程序不会覆盖此`Initialize`方法。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-262">The custom site map provider we'll build in Step 6 does not override this `Initialize` method.</span></span> <span data-ttu-id="9b8c4-263">有关使用的示例`Initialize`方法，请参阅[Jeff Prosise](http://www.wintellect.com/Weblogs/CategoryView,category,Jeff%20Prosise.aspx) s[存储在 SQL Server 中的站点映射](https://msdn.microsoft.com/msdnmag/issues/05/06/WickedCode/)文章。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-263">For an example of using the `Initialize` method, refer to [Jeff Prosise](http://www.wintellect.com/Weblogs/CategoryView,category,Jeff%20Prosise.aspx) s [Storing Site Maps in SQL Server](https://msdn.microsoft.com/msdnmag/issues/05/06/WickedCode/) article.</span></span>


## <a name="step-6-creating-the-custom-site-map-provider"></a><span data-ttu-id="9b8c4-264">步骤 6： 创建自定义站点映射提供程序</span><span class="sxs-lookup"><span data-stu-id="9b8c4-264">Step 6: Creating the Custom Site Map Provider</span></span>

<span data-ttu-id="9b8c4-265">若要创建自定义站点地图提供程序的生成中的类别和产品 Northwind 数据库中的站点映射，我们需要创建一个类以扩展`StaticSiteMapProvider`。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-265">To create a custom site map provider that builds the site map from the categories and products in the Northwind database, we need to create a class that extends `StaticSiteMapProvider`.</span></span> <span data-ttu-id="9b8c4-266">在步骤 1 中要求您将添加`CustomProviders`文件夹中的`App_Code`文件夹-将新类添加到此文件夹名为`NorthwindSiteMapProvider`。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-266">In Step 1 I asked you to add a `CustomProviders` folder in the `App_Code` folder - add a new class to this folder named `NorthwindSiteMapProvider`.</span></span> <span data-ttu-id="9b8c4-267">将下面的代码添加到 `NorthwindSiteMapProvider` 类中:</span><span class="sxs-lookup"><span data-stu-id="9b8c4-267">Add the following code to the `NorthwindSiteMapProvider` class:</span></span>


[!code-csharp[Main](building-a-custom-database-driven-site-map-provider-cs/samples/sample6.cs)]

<span data-ttu-id="9b8c4-268">让我们来首先了解此类 s`BuildSiteMap`方法，开头[`lock`语句](https://msdn.microsoft.com/library/c5kehkcz.aspx)。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-268">Let s start with exploring this class s `BuildSiteMap` method, which starts with a [`lock` statement](https://msdn.microsoft.com/library/c5kehkcz.aspx).</span></span> <span data-ttu-id="9b8c4-269">`lock`语句只允许一个线程每次输入，从而序列化其代码的访问权限和防止两个并发线程上另一个 s 数量屈指可数单步执行。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-269">The `lock` statement only allows one thread at a time to enter, thereby serializing access to its code and preventing two concurrent threads from stepping on one another s toes.</span></span>

<span data-ttu-id="9b8c4-270">在类级别`SiteMapNode`变量`root`用于缓存站点地图结构。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-270">The class-level `SiteMapNode` variable `root` is used to cache the site map structure.</span></span> <span data-ttu-id="9b8c4-271">第一次，或后已修改基础数据，第一次构造站点图时`root`将为`null`并将构建站点地图结构。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-271">When the site map is constructed for the first time, or for the first time after the underlying data has been modified, `root` will be `null` and the site map structure will be constructed.</span></span> <span data-ttu-id="9b8c4-272">站点地图的根节点分配给`root`在构造期间进程，以便下一次此方法调用时，`root`不会`null`。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-272">The site map s root node is assigned to `root` during the construction process so that the next time this method is called, `root` will not be `null`.</span></span> <span data-ttu-id="9b8c4-273">因此，只要`root`不是`null`站点地图结构将返回到调用方无需重新创建它。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-273">Consequently, so long as `root` is not `null` the site map structure will be returned to the caller without having to recreate it.</span></span>

<span data-ttu-id="9b8c4-274">如果根是`null`，站点地图结构创建中的产品和类别信息。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-274">If root is `null`, the site map structure is created from the product and category information.</span></span> <span data-ttu-id="9b8c4-275">创建生成站点地图`SiteMapNode`实例，然后组成的层次结构，通过调用`StaticSiteMapProvider`类的`AddNode`方法。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-275">The site map is built by creating the `SiteMapNode` instances and then forming the hierarchy through calls to the `StaticSiteMapProvider` class s `AddNode` method.</span></span> <span data-ttu-id="9b8c4-276">`AddNode` 执行存储各种内部簿记`SiteMapNode`实例中`Hashtable`。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-276">`AddNode` performs the internal bookkeeping, storing the assorted `SiteMapNode` instances in a `Hashtable`.</span></span> <span data-ttu-id="9b8c4-277">我们开始构造层次结构之前，首先通过调用`Clear`方法，从内部的元素将清除`Hashtable`。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-277">Before we start constructing the hierarchy, we start by calling the `Clear` method, which clears out the elements from the internal `Hashtable`.</span></span> <span data-ttu-id="9b8c4-278">下一步，`ProductsBLL`类 s`GetProducts`方法，并生成`ProductsDataTable`存储在本地变量中。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-278">Next, the `ProductsBLL` class s `GetProducts` method and the resulting `ProductsDataTable` are stored in local variables.</span></span>

<span data-ttu-id="9b8c4-279">站点映射的构造首先创建根节点并将其分配给`root`。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-279">The site map s construction begins by creating the root node and assigning it to `root`.</span></span> <span data-ttu-id="9b8c4-280">重载[ `SiteMapNode` s 构造函数](https://msdn.microsoft.com/library/system.web.sitemapnode.sitemapnode.aspx)用于此处并在这整个`BuildSiteMap`传递以下信息：</span><span class="sxs-lookup"><span data-stu-id="9b8c4-280">The overload of the [`SiteMapNode` s constructor](https://msdn.microsoft.com/library/system.web.sitemapnode.sitemapnode.aspx) used here and throughout this `BuildSiteMap` is passed the following information:</span></span>

- <span data-ttu-id="9b8c4-281">对站点地图提供程序的引用 (`this`)。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-281">A reference to the site map provider (`this`).</span></span>
- <span data-ttu-id="9b8c4-282">`SiteMapNode` S `Key`。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-282">The `SiteMapNode` s `Key`.</span></span> <span data-ttu-id="9b8c4-283">这所必需的值必须是唯一的每个`SiteMapNode`。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-283">This required value must be unique for each `SiteMapNode`.</span></span>
- <span data-ttu-id="9b8c4-284">`SiteMapNode` S `Url`。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-284">The `SiteMapNode` s `Url`.</span></span> <span data-ttu-id="9b8c4-285">`Url` 是可选的但是，如果提供，每个`SiteMapNode`s`Url`值必须唯一。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-285">`Url` is optional, but if provided, each `SiteMapNode` s `Url` value must be unique.</span></span>
- <span data-ttu-id="9b8c4-286">`SiteMapNode` S `Title`，这是所必需。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-286">The `SiteMapNode` s `Title`, which is required.</span></span>

<span data-ttu-id="9b8c4-287">`AddNode(root)`方法调用添加`SiteMapNode``root`到作为根站点映射。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-287">The `AddNode(root)` method call adds the `SiteMapNode` `root` to the site map as the root.</span></span> <span data-ttu-id="9b8c4-288">下一步，每个`ProductRow`在`ProductsDataTable`枚举。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-288">Next, each `ProductRow` in the `ProductsDataTable` is enumerated.</span></span> <span data-ttu-id="9b8c4-289">如果已存在`SiteMapNode`当前产品 s 类别，引用它。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-289">If there already exists a `SiteMapNode` for the current product s category, it is referenced.</span></span> <span data-ttu-id="9b8c4-290">否则为新`SiteMapNode`创建并添加为的子类别`SiteMapNode``root`通过`AddNode(categoryNode, root)`方法调用。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-290">Otherwise, a new `SiteMapNode` for the category is created and added as a child of the `SiteMapNode``root` through the `AddNode(categoryNode, root)` method call.</span></span> <span data-ttu-id="9b8c4-291">之后相应的类别`SiteMapNode`已找到或创建的节点`SiteMapNode`是为当前的产品创建和添加为类别的子`SiteMapNode`通过`AddNode(productNode, categoryNode)`。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-291">After the appropriate category `SiteMapNode` node has been found or created, a `SiteMapNode` is created for the current product and added as a child of the category `SiteMapNode` via `AddNode(productNode, categoryNode)`.</span></span> <span data-ttu-id="9b8c4-292">请注意，类别`SiteMapNode`s`Url`属性值是`~/SiteMapProvider/ProductsByCategory.aspx?CategoryID=categoryID`while 产品`SiteMapNode`s`Url`属性分配`~/SiteMapNode/ProductDetails.aspx?ProductID=productID`。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-292">Note that the category `SiteMapNode` s `Url` property value is `~/SiteMapProvider/ProductsByCategory.aspx?CategoryID=categoryID` while the product `SiteMapNode` s `Url` property is assigned `~/SiteMapNode/ProductDetails.aspx?ProductID=productID`.</span></span>

> [!NOTE]
> <span data-ttu-id="9b8c4-293">这些产品的数据库`NULL`值及其`CategoryID`按类别分组`SiteMapNode`其`Title`属性设置为 None，它的`Url`属性设置为空字符串。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-293">Those products that have a database `NULL` value for their `CategoryID` are grouped under a category `SiteMapNode` whose `Title` property is set to None and whose `Url` property is set to an empty string.</span></span> <span data-ttu-id="9b8c4-294">我决定设置`Url`为空字符串以来`ProductBLL`类 s`GetProductsByCategory(categoryID)`方法目前缺少的功能，以返回与仅对这些产品`NULL``CategoryID`值。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-294">I decided to set `Url` to an empty string since the `ProductBLL` class s `GetProductsByCategory(categoryID)` method currently lacks the capability to return just those products with a `NULL` `CategoryID` value.</span></span> <span data-ttu-id="9b8c4-295">此外，我要演示导航控件的呈现方式`SiteMapNode`缺少的值及其`Url`属性。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-295">Also, I wanted to demonstrate how the navigation controls render a `SiteMapNode` that lacks a value for its `Url` property.</span></span> <span data-ttu-id="9b8c4-296">我鼓励您扩展本教程中，以便无`SiteMapNode`s`Url`属性指向`ProductsByCategory.aspx`，但仅显示与产品`NULL``CategoryID`值。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-296">I encourage you to extend this tutorial so that the None `SiteMapNode` s `Url` property points to `ProductsByCategory.aspx`, yet only displays the products with `NULL` `CategoryID` values.</span></span>


<span data-ttu-id="9b8c4-297">构造站点图后, 的任意对象添加到使用 SQL 缓存依赖项上的数据缓存`Categories`并`Products`表通过`AggregateCacheDependency`对象。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-297">After constructing the site map, an arbitrary object is added to the data cache using a SQL cache dependency on the `Categories` and `Products` tables through an `AggregateCacheDependency` object.</span></span> <span data-ttu-id="9b8c4-298">我们探讨了前面教程中，使用 SQL 缓存依赖项*使用 SQL 缓存依赖项*。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-298">We explored using SQL cache dependencies in the preceding tutorial, *Using SQL Cache Dependencies*.</span></span> <span data-ttu-id="9b8c4-299">自定义站点地图提供程序，但是，使用的数据缓存的重载`Insert`方法，我们 ve 有待探索。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-299">The custom site map provider, however, uses an overload of the data cache s `Insert` method that we ve yet to explore.</span></span> <span data-ttu-id="9b8c4-300">此重载接受作为其最后一个输入参数从缓存中移除对象时调用的委托。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-300">This overload accepts as its final input parameter a delegate that is called when the object is removed from the cache.</span></span> <span data-ttu-id="9b8c4-301">具体而言，我们传入的新[`CacheItemRemovedCallback`委托](https://msdn.microsoft.com/library/system.web.caching.cacheitemremovedcallback.aspx)指向`OnSiteMapChanged`方法定义中的进一步`NorthwindSiteMapProvider`类。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-301">Specifically, we pass in a new [`CacheItemRemovedCallback` delegate](https://msdn.microsoft.com/library/system.web.caching.cacheitemremovedcallback.aspx) that points to the `OnSiteMapChanged` method defined further down in the `NorthwindSiteMapProvider` class.</span></span>

> [!NOTE]
> <span data-ttu-id="9b8c4-302">站点地图的内存中表示缓存通过类级别变量`root`。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-302">The in-memory representation of the site map is cached through the class-level variable `root`.</span></span> <span data-ttu-id="9b8c4-303">由于只有一个实例的自定义站点映射提供程序类，因为该实例在所有线程之间共享 web 应用程序中，此类变量用作缓存。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-303">Since there is only one instance of the custom site map provider class and since that instance is shared among all threads in the web application, this class variable serves as a cache.</span></span> <span data-ttu-id="9b8c4-304">`BuildSiteMap`方法还将使用数据缓存，但仅作为一种方法在基础数据库中的数据时收到通知`Categories`或`Products`表的更改。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-304">The `BuildSiteMap` method also uses the data cache, but only as a means to receive notification when the underlying database data in the `Categories` or `Products` tables changes.</span></span> <span data-ttu-id="9b8c4-305">请注意，将放入数据缓存的值只是当前日期和时间。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-305">Note that the value put into the data cache is just the current date and time.</span></span> <span data-ttu-id="9b8c4-306">实际的站点地图数据是*不*放入数据缓存中。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-306">The actual site map data is *not* put in the data cache.</span></span>


<span data-ttu-id="9b8c4-307">`BuildSiteMap`方法完成通过返回站点地图的根节点。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-307">The `BuildSiteMap` method completes by returning the root node of the site map.</span></span>

<span data-ttu-id="9b8c4-308">剩余方法都是非常简单。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-308">The remaining methods are fairly straightforward.</span></span> <span data-ttu-id="9b8c4-309">`GetRootNodeCore` 负责返回的根节点。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-309">`GetRootNodeCore` is responsible for returning the root node.</span></span> <span data-ttu-id="9b8c4-310">由于`BuildSiteMap`返回的根`GetRootNodeCore`只需返回`BuildSiteMap`s 返回值。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-310">Since `BuildSiteMap` returns the root, `GetRootNodeCore` simply returns `BuildSiteMap` s return value.</span></span> <span data-ttu-id="9b8c4-311">`OnSiteMapChanged`方法设置`root`回`null`中删除缓存项的时间。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-311">The `OnSiteMapChanged` method sets `root` back to `null` when the cache item is removed.</span></span> <span data-ttu-id="9b8c4-312">使用重新设置为根`null`，则下次`BuildSiteMap`是调用，站点地图结构将重新生成。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-312">With root set back to `null`, the next time `BuildSiteMap` is invoked, the site map structure will be rebuilt.</span></span> <span data-ttu-id="9b8c4-313">最后，`CachedDate`属性返回的数据缓存中存储的日期和时间值，如果存在这样的值。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-313">Lastly, the `CachedDate` property returns the date and time value stored in the data cache, if such a value exists.</span></span> <span data-ttu-id="9b8c4-314">页面开发人员可以使用此属性来确定上次缓存站点地图数据。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-314">This property can be used by a page developer to determine when the site map data was last cached.</span></span>

## <a name="step-7-registering-thenorthwindsitemapprovider"></a><span data-ttu-id="9b8c4-315">步骤 7： 注册`NorthwindSiteMapProvider`</span><span class="sxs-lookup"><span data-stu-id="9b8c4-315">Step 7: Registering the`NorthwindSiteMapProvider`</span></span>

<span data-ttu-id="9b8c4-316">为了使 web 应用程序以使用`NorthwindSiteMapProvider`站点地图提供程序在步骤 6 中创建，我们需要将其在注册`<siteMap>`一部分`Web.config`。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-316">In order for our web application to use the `NorthwindSiteMapProvider` site map provider created in Step 6, we need to register it in the `<siteMap>` section of `Web.config`.</span></span> <span data-ttu-id="9b8c4-317">具体而言，添加以下标记内的`<system.web>`中的元素`Web.config`:</span><span class="sxs-lookup"><span data-stu-id="9b8c4-317">Specifically, add the following markup within the `<system.web>` element in `Web.config`:</span></span>


[!code-xml[Main](building-a-custom-database-driven-site-map-provider-cs/samples/sample7.xml)]

<span data-ttu-id="9b8c4-318">此标记有两个用途： 首先，它表明内置`AspNetXmlSiteMapProvider`是默认站点映射提供程序; 其次，它会注册的自定义站点地图提供程序在步骤 6 中创建与 Northwind 的用户友好名称。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-318">This markup does two things: first, it indicates that the built-in `AspNetXmlSiteMapProvider` is the default site map provider; second, it registers the custom site map provider created in Step 6 with the human-friendly name Northwind .</span></span>

> [!NOTE]
> <span data-ttu-id="9b8c4-319">在站点地图提供程序位于应用程序 s`App_Code`文件夹中，值`type`属性是只是类名称。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-319">For site map providers located in the application s `App_Code` folder, the value of the `type` attribute is simply the class name.</span></span> <span data-ttu-id="9b8c4-320">或者，自定义站点映射提供程序无法在一个单独的类库项目中使用创建编译的程序集放置在 web 应用程序的`/Bin`目录。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-320">Alternatively, the custom site map provider could have been created in a separate Class Library project with the compiled assembly placed in the web application s `/Bin` directory.</span></span> <span data-ttu-id="9b8c4-321">在这种情况下，`type`属性的值将是*Namespace*。*ClassName*， *AssemblyName* 。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-321">In that case, the `type` attribute value would be *Namespace*.*ClassName*, *AssemblyName* .</span></span>


<span data-ttu-id="9b8c4-322">更新后`Web.config`，请花费片刻时间浏览器中查看任何页上，从这些教程。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-322">After updating `Web.config`, take a moment to view any page from the tutorials in a browser.</span></span> <span data-ttu-id="9b8c4-323">请注意，在左侧的导航界面仍显示的各个部分，教程中定义`Web.sitemap`。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-323">Note that the navigation interface on the left still shows the sections and tutorials defined in `Web.sitemap`.</span></span> <span data-ttu-id="9b8c4-324">这是因为我们已将保留`AspNetXmlSiteMapProvider`作为默认提供程序。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-324">This is because we left `AspNetXmlSiteMapProvider` as the default provider.</span></span> <span data-ttu-id="9b8c4-325">若要创建使用的导航用户界面元素`NorthwindSiteMapProvider`，我们将需要显式指定，应使用 Northwind 站点地图提供程序。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-325">In order to create a navigation user interface element that uses the `NorthwindSiteMapProvider`, we'll need to explicitly specify that the Northwind site map provider should be used.</span></span> <span data-ttu-id="9b8c4-326">我们将了解如何在步骤 8 中实现这一点。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-326">We'll see how to accomplish this in Step 8.</span></span>

## <a name="step-8-displaying-site-map-information-using-the-custom-site-map-provider"></a><span data-ttu-id="9b8c4-327">步骤 8： 显示使用的自定义站点地图提供程序的站点映射信息</span><span class="sxs-lookup"><span data-stu-id="9b8c4-327">Step 8: Displaying Site Map Information Using the Custom Site Map Provider</span></span>

<span data-ttu-id="9b8c4-328">使用自定义站点映射提供程序创建并注册中`Web.config`，我们已准备好添加到导航控件重新`Default.aspx`， `ProductsByCategory.aspx`，和`ProductDetails.aspx`中的页面`SiteMapProvider`文件夹。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-328">With the custom site map provider created and registered in `Web.config`, we re ready to add navigation controls to the `Default.aspx`, `ProductsByCategory.aspx`, and `ProductDetails.aspx` pages in the `SiteMapProvider` folder.</span></span> <span data-ttu-id="9b8c4-329">首先打开`Default.aspx`页上，并将其拖`SiteMapPath`从工具箱拖到设计器。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-329">Start by opening the `Default.aspx` page and drag a `SiteMapPath` from the Toolbox onto the Designer.</span></span> <span data-ttu-id="9b8c4-330">SiteMapPath 控件位于工具箱的导航部分。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-330">The SiteMapPath control is located in the Navigation section of the Toolbox.</span></span>


<span data-ttu-id="9b8c4-331">[![将 SiteMapPath 添加到 Default.aspx](building-a-custom-database-driven-site-map-provider-cs/_static/image19.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image18.gif)</span><span class="sxs-lookup"><span data-stu-id="9b8c4-331">[![Add a SiteMapPath to Default.aspx](building-a-custom-database-driven-site-map-provider-cs/_static/image19.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image18.gif)</span></span>

<span data-ttu-id="9b8c4-332">**图 16**： 添加到 SiteMapPath `Default.aspx` ([单击以查看实际尺寸的图像](building-a-custom-database-driven-site-map-provider-cs/_static/image20.gif))</span><span class="sxs-lookup"><span data-stu-id="9b8c4-332">**Figure 16**: Add a SiteMapPath to `Default.aspx` ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image20.gif))</span></span>


<span data-ttu-id="9b8c4-333">SiteMapPath 控件显示痕迹导航，，该值指示站点地图中的当前页的位置。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-333">The SiteMapPath control displays a breadcrumb, indicating the current page s location within the site map.</span></span> <span data-ttu-id="9b8c4-334">我们添加到主页面顶部的 SiteMapPath 回到*母版页和站点导航*教程。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-334">We added a SiteMapPath to the top of the master page back in the *Master Pages and Site Navigation* tutorial.</span></span>

<span data-ttu-id="9b8c4-335">请花费片刻时间来查看此页上的通过浏览器。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-335">Take a moment to view this page through a browser.</span></span> <span data-ttu-id="9b8c4-336">在图 16 中添加 SiteMapPath 使用的默认站点地图提供程序，将从其数据提取`Web.sitemap`。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-336">The SiteMapPath added in Figure 16 uses the default site map provider, pulling its data from `Web.sitemap`.</span></span> <span data-ttu-id="9b8c4-337">因此，则痕迹导航主页显示&gt;自定义站点地图，就像在右上角痕迹导航。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-337">Therefore, the breadcrumb shows Home &gt; Customizing the Site Map, just like the breadcrumb in the upper-right corner.</span></span>


<span data-ttu-id="9b8c4-338">[![痕迹导航中使用的默认站点地图提供程序](building-a-custom-database-driven-site-map-provider-cs/_static/image22.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image21.gif)</span><span class="sxs-lookup"><span data-stu-id="9b8c4-338">[![The Breadcrumb Uses the Default Site Map Provider](building-a-custom-database-driven-site-map-provider-cs/_static/image22.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image21.gif)</span></span>

<span data-ttu-id="9b8c4-339">**图 17**： 痕迹导航使用默认站点映射提供程序 ([单击以查看实际尺寸的图像](building-a-custom-database-driven-site-map-provider-cs/_static/image23.gif))</span><span class="sxs-lookup"><span data-stu-id="9b8c4-339">**Figure 17**: The Breadcrumb Uses the Default Site Map Provider ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image23.gif))</span></span>


<span data-ttu-id="9b8c4-340">如果希望使用我们在步骤 6 中创建的自定义站点地图提供 SiteMapPath 图 16 中添加，请设置其[`SiteMapProvider`属性](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sitemappath.sitemapprovider.aspx)到 Northwind，我们分配给的名称`NorthwindSiteMapProvider`中`Web.config`。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-340">To have the SiteMapPath added in Figure 16 use the custom site map provider we created in Step 6, set its [`SiteMapProvider` property](https://msdn.microsoft.com/library/system.web.ui.webcontrols.sitemappath.sitemapprovider.aspx) to Northwind, the name we assigned to the `NorthwindSiteMapProvider` in `Web.config`.</span></span> <span data-ttu-id="9b8c4-341">遗憾的是，在设计器仍会继续使用的默认站点地图提供程序，但如果通过浏览器页面访问此属性更改后您将看到痕迹导航现在使用的自定义站点地图提供程序。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-341">Unfortunately, the Designer continues to use the default site map provider, but if you visit the page through a browser after making this property change you'll see that the breadcrumb now uses the custom site map provider.</span></span>


<span data-ttu-id="9b8c4-342">[![痕迹导航现在使用自定义站点映射提供程序 NorthwindSiteMapProvider](building-a-custom-database-driven-site-map-provider-cs/_static/image25.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image24.gif)</span><span class="sxs-lookup"><span data-stu-id="9b8c4-342">[![The Breadcrumb Now Uses the Custom Site Map Provider NorthwindSiteMapProvider](building-a-custom-database-driven-site-map-provider-cs/_static/image25.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image24.gif)</span></span>

<span data-ttu-id="9b8c4-343">**图 18**： 痕迹导航现在使用自定义站点地图提供程序`NorthwindSiteMapProvider`([单击以查看实际尺寸的图像](building-a-custom-database-driven-site-map-provider-cs/_static/image26.gif))</span><span class="sxs-lookup"><span data-stu-id="9b8c4-343">**Figure 18**: The Breadcrumb Now Uses the Custom Site Map Provider `NorthwindSiteMapProvider` ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image26.gif))</span></span>


<span data-ttu-id="9b8c4-344">SiteMapPath 控件显示中的功能更强的用户界面`ProductsByCategory.aspx`和`ProductDetails.aspx`页。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-344">The SiteMapPath control displays a more functional user interface in the `ProductsByCategory.aspx` and `ProductDetails.aspx` pages.</span></span> <span data-ttu-id="9b8c4-345">将 SiteMapPath 添加到这些页面，设置`SiteMapProvider`向 Northwind 中的属性。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-345">Add a SiteMapPath to these pages, setting the `SiteMapProvider` property in both to Northwind.</span></span> <span data-ttu-id="9b8c4-346">从`Default.aspx`单击饮料，查看产品链接，然后单击 Chai 茶的查看详细信息链接。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-346">From `Default.aspx` click on the View Products link for Beverages, and then on the View Details link for Chai Tea.</span></span> <span data-ttu-id="9b8c4-347">痕迹导航如图 19 所示，包括当前的站点映射节 （Chai 茶） 和其祖先： Beverages 和所有类别。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-347">As Figure 19 shows, the breadcrumb includes the current site map section ( Chai Tea ) and its ancestors: Beverages and All Categories .</span></span>


<span data-ttu-id="9b8c4-348">[![痕迹导航现在使用自定义站点映射提供程序 NorthwindSiteMapProvider](building-a-custom-database-driven-site-map-provider-cs/_static/image27.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image21.png)</span><span class="sxs-lookup"><span data-stu-id="9b8c4-348">[![The Breadcrumb Now Uses the Custom Site Map Provider NorthwindSiteMapProvider](building-a-custom-database-driven-site-map-provider-cs/_static/image27.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image21.png)</span></span>

<span data-ttu-id="9b8c4-349">**图 19**： 痕迹导航现在使用自定义站点地图提供程序`NorthwindSiteMapProvider`([单击以查看实际尺寸的图像](building-a-custom-database-driven-site-map-provider-cs/_static/image22.png))</span><span class="sxs-lookup"><span data-stu-id="9b8c4-349">**Figure 19**: The Breadcrumb Now Uses the Custom Site Map Provider `NorthwindSiteMapProvider` ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image22.png))</span></span>


<span data-ttu-id="9b8c4-350">除了 SiteMapPath，如菜单和 TreeView 控件，可以使用其他导航用户界面元素。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-350">Other navigation user interface elements can be used in addition to the SiteMapPath, such as the Menu and TreeView controls.</span></span> <span data-ttu-id="9b8c4-351">`Default.aspx`， `ProductsByCategory.aspx`，和`ProductDetails.aspx`页面中的下载本教程中，例如，所有包括菜单控件 （请参阅图 20）。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-351">The `Default.aspx`, `ProductsByCategory.aspx`, and `ProductDetails.aspx` pages in the download for this tutorial, for example, all include Menu controls (see Figure 20).</span></span> <span data-ttu-id="9b8c4-352">请参阅[检查 ASP.NET 2.0 的站点导航功能](http://aspnet.4guysfromrolla.com/articles/111605-1.aspx)并[使用站点导航控件](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/navigation/sitenavcontrols.aspx)部分[ASP.NET 2.0 快速入门](https://quickstarts.asp.net/QuickStartv20/aspnet/)，更深入了解导航控件和 ASP.NET 2.0 中的站点映射系统。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-352">See [Examining ASP.NET 2.0 s Site Navigation Features](http://aspnet.4guysfromrolla.com/articles/111605-1.aspx) and the [Using Site Navigation Controls](https://quickstarts.asp.net/QuickStartv20/aspnet/doc/navigation/sitenavcontrols.aspx) section of the [ASP.NET 2.0 QuickStarts](https://quickstarts.asp.net/QuickStartv20/aspnet/) for a more in-depth look at the navigation controls and site map system in ASP.NET 2.0.</span></span>


<span data-ttu-id="9b8c4-353">[![菜单控件列出每个类别和产品](building-a-custom-database-driven-site-map-provider-cs/_static/image29.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image28.gif)</span><span class="sxs-lookup"><span data-stu-id="9b8c4-353">[![The Menu Control Lists Each of the Categories and Products](building-a-custom-database-driven-site-map-provider-cs/_static/image29.gif)](building-a-custom-database-driven-site-map-provider-cs/_static/image28.gif)</span></span>

<span data-ttu-id="9b8c4-354">**图 20**: 菜单控件列出了每个类别和产品 ([单击以查看实际尺寸的图像](building-a-custom-database-driven-site-map-provider-cs/_static/image30.gif))</span><span class="sxs-lookup"><span data-stu-id="9b8c4-354">**Figure 20**: The Menu Control Lists Each of the Categories and Products ([Click to view full-size image](building-a-custom-database-driven-site-map-provider-cs/_static/image30.gif))</span></span>


<span data-ttu-id="9b8c4-355">在本教程前面所述，可以通过以编程方式访问站点地图结构`SiteMap`类。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-355">As mentioned earlier in this tutorial, the site map structure can be accessed programmatically through the `SiteMap` class.</span></span> <span data-ttu-id="9b8c4-356">以下代码将返回根目录`SiteMapNode`的默认提供程序：</span><span class="sxs-lookup"><span data-stu-id="9b8c4-356">The following code returns the root `SiteMapNode` of the default provider:</span></span>


[!code-csharp[Main](building-a-custom-database-driven-site-map-provider-cs/samples/sample8.cs)]

<span data-ttu-id="9b8c4-357">由于`AspNetXmlSiteMapProvider`是默认提供程序对于我们的应用程序，上面的代码将返回定义中的根节点`Web.sitemap`。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-357">Since the `AspNetXmlSiteMapProvider` is the default provider for our application, the above code would return the root node defined in `Web.sitemap`.</span></span> <span data-ttu-id="9b8c4-358">若要引用而不是默认的站点地图提供，使用`SiteMap`类 s [ `Providers`属性](https://msdn.microsoft.com/library/system.web.sitemap.providers.aspx)如下所示：</span><span class="sxs-lookup"><span data-stu-id="9b8c4-358">To reference a site map provider other than the default, use the `SiteMap` class s [`Providers` property](https://msdn.microsoft.com/library/system.web.sitemap.providers.aspx) like so:</span></span>


[!code-csharp[Main](building-a-custom-database-driven-site-map-provider-cs/samples/sample9.cs)]

<span data-ttu-id="9b8c4-359">其中*名称*是自定义站点映射提供程序 （web 应用程序罗斯文数据库） 的名称。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-359">Where *name* is the name of the custom site map provider ( Northwind, for our web application).</span></span>

<span data-ttu-id="9b8c4-360">若要访问特定于站点地图提供程序的成员，请使用`SiteMap.Providers["name"]`来检索提供程序实例，然后将其转换为适当的类型。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-360">To access a member specific to a site map provider, use `SiteMap.Providers["name"]` to retrieve the provider instance and then cast it to the appropriate type.</span></span> <span data-ttu-id="9b8c4-361">例如，若要显示`NorthwindSiteMapProvider`s`CachedDate`属性在 ASP.NET 页中，使用以下代码：</span><span class="sxs-lookup"><span data-stu-id="9b8c4-361">For example, to display the `NorthwindSiteMapProvider` s `CachedDate` property in an ASP.NET page, use the following code:</span></span>


[!code-csharp[Main](building-a-custom-database-driven-site-map-provider-cs/samples/sample10.cs)]

> [!NOTE]
> <span data-ttu-id="9b8c4-362">请确保测试出 SQL 缓存依赖项功能。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-362">Be sure to test out the SQL cache dependency feature.</span></span> <span data-ttu-id="9b8c4-363">访问后`Default.aspx`， `ProductsByCategory.aspx`，和`ProductDetails.aspx`页，请转到之一中编辑、 插入和删除部分的教程和编辑类别或产品的名称。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-363">After visiting the `Default.aspx`, `ProductsByCategory.aspx`, and `ProductDetails.aspx` pages, go to one of the tutorials in the Editing, Inserting, and Deleting section and edit the name of a category or product.</span></span> <span data-ttu-id="9b8c4-364">然后返回到中的页面之一`SiteMapProvider`文件夹。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-364">Then return to one of the pages in the `SiteMapProvider` folder.</span></span> <span data-ttu-id="9b8c4-365">假设要注意到基础数据库更改的轮询机制已经历了足够的时间，站点图应更新以显示新产品或类别名称。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-365">Assuming enough time has passed for the polling mechanism to note the change to the underlying database, the site map should be updated to show the new product or category name.</span></span>


## <a name="summary"></a><span data-ttu-id="9b8c4-366">总结</span><span class="sxs-lookup"><span data-stu-id="9b8c4-366">Summary</span></span>

<span data-ttu-id="9b8c4-367">ASP.NET 2.0 的站点映射功能包括`SiteMap`类，大量的内置导航 Web 控件，并保存到 XML 文件的默认站点地图提供程序所需的站点映射信息。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-367">ASP.NET 2.0 s site map features includes a `SiteMap` class, a number of built-in navigation Web controls, and a default site map provider that expects the site map information persisted to an XML file.</span></span> <span data-ttu-id="9b8c4-368">若要使用来自其他源如从数据库中，应用程序 s 体系结构或远程 Web 服务，我们需要创建自定义的站点地图提供程序站点映射信息。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-368">In order to use site map information from some other source such as from a database, the application s architecture, or a remote Web service we need to create a custom site map provider.</span></span> <span data-ttu-id="9b8c4-369">这涉及到创建直接或间接派生的类从`SiteMapProvider`类。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-369">This involves creating a class that derives, directly or indirectly, from the `SiteMapProvider` class.</span></span>

<span data-ttu-id="9b8c4-370">在本教程中我们已了解如何创建基于从应用程序体系结构中拣出的产品和类别信息的站点映射的自定义站点映射提供程序。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-370">In this tutorial we saw how to create a custom site map provider that based the site map on the product and category information culled from the application architecture.</span></span> <span data-ttu-id="9b8c4-371">我们的提供程序扩展`StaticSiteMapProvider`类和引起创建`BuildSiteMap`检索了数据的方法构造站点映射层次结构，并缓存在类级别变量中生成的结构。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-371">Our provider extended the `StaticSiteMapProvider` class and entailed creating a `BuildSiteMap` method that retrieved the data, constructed the site map hierarchy, and cached the resulting structure in a class-level variable.</span></span> <span data-ttu-id="9b8c4-372">我们使用 SQL 缓存依赖项的回调函数具有要使之无效的已缓存结构时的基础`Categories`或`Products`修改数据。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-372">We used a SQL cache dependency with a callback function to invalidate the cached structure when the underlying `Categories` or `Products` data is modified.</span></span>

<span data-ttu-id="9b8c4-373">快乐编程 ！</span><span class="sxs-lookup"><span data-stu-id="9b8c4-373">Happy Programming!</span></span>

## <a name="further-reading"></a><span data-ttu-id="9b8c4-374">其他阅读材料</span><span class="sxs-lookup"><span data-stu-id="9b8c4-374">Further Reading</span></span>

<span data-ttu-id="9b8c4-375">在本教程中讨论的主题的详细信息，请参阅以下资源：</span><span class="sxs-lookup"><span data-stu-id="9b8c4-375">For more information on the topics discussed in this tutorial, refer to the following resources:</span></span>

- <span data-ttu-id="9b8c4-376">[SQL Server 中存储的站点地图](https://msdn.microsoft.com/msdnmag/issues/05/06/WickedCode/)和[以前已久的 SQL 站点地图提供程序](https://msdn.microsoft.com/msdnmag/issues/06/02/wickedcode/default.aspx)</span><span class="sxs-lookup"><span data-stu-id="9b8c4-376">[Storing Site Maps in SQL Server](https://msdn.microsoft.com/msdnmag/issues/05/06/WickedCode/) and [The SQL Site Map Provider You ve Been Waiting For](https://msdn.microsoft.com/msdnmag/issues/06/02/wickedcode/default.aspx)</span></span>
- [<span data-ttu-id="9b8c4-377">ASP.NET 2.0 看 s 提供程序模型</span><span class="sxs-lookup"><span data-stu-id="9b8c4-377">A Look at ASP.NET 2.0 s Provider Model</span></span>](http://aspnet.4guysfromrolla.com/articles/101905-1.aspx)
- [<span data-ttu-id="9b8c4-378">提供程序工具包</span><span class="sxs-lookup"><span data-stu-id="9b8c4-378">The Provider Toolkit</span></span>](https://msdn.microsoft.com/asp.net/aa336558.aspx)
- [<span data-ttu-id="9b8c4-379">检查 ASP.NET 2.0 的站点导航功能</span><span class="sxs-lookup"><span data-stu-id="9b8c4-379">Examining ASP.NET 2.0 s Site Navigation Features</span></span>](http://aspnet.4guysfromrolla.com/articles/111605-1.aspx)

## <a name="about-the-author"></a><span data-ttu-id="9b8c4-380">关于作者</span><span class="sxs-lookup"><span data-stu-id="9b8c4-380">About the Author</span></span>

<span data-ttu-id="9b8c4-381">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml)的七个部 asp/ASP.NET 书籍并创办了作者[4GuysFromRolla.com](http://www.4guysfromrolla.com)，自 1998 年以来一直致力于 Microsoft Web 技术。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-381">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="9b8c4-382">Scott 是独立的顾问、 培训师和编写器。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-382">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="9b8c4-383">他最新著作是[ *Sams Teach 自己 ASP.NET 2.0 24 小时内*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-383">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="9b8c4-384">他可以到达[ mitchell@4GuysFromRolla.com。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="9b8c4-384">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="9b8c4-385">或通过他的博客，其中，请参阅[ http://ScottOnWriting.NET ](http://ScottOnWriting.NET)。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-385">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="9b8c4-386">特别感谢</span><span class="sxs-lookup"><span data-stu-id="9b8c4-386">Special Thanks To</span></span>

<span data-ttu-id="9b8c4-387">很多有用的审阅者已评审本系列教程。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-387">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="9b8c4-388">本教程中的潜在顾客审阅者已 Dave Gardner、 Zack Jones、 Teresa Murphy 和伯纳黛特 Leigh。</span><span class="sxs-lookup"><span data-stu-id="9b8c4-388">Lead reviewers for this tutorial were Dave Gardner, Zack Jones, Teresa Murphy, and Bernadette Leigh.</span></span> <span data-ttu-id="9b8c4-389">是否有兴趣查看我即将推出的 MSDN 文章？</span><span class="sxs-lookup"><span data-stu-id="9b8c4-389">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="9b8c4-390">如果是这样，给我在行[ mitchell@4GuysFromRolla.com。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="9b8c4-390">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> [<span data-ttu-id="9b8c4-391">下一篇</span><span class="sxs-lookup"><span data-stu-id="9b8c4-391">Next</span></span>](building-a-custom-database-driven-site-map-provider-vb.md)
