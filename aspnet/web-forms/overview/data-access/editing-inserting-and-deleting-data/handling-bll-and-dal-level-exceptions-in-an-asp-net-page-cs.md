---
uid: web-forms/overview/data-access/editing-inserting-and-deleting-data/handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs
title: 处理 BLL 和 DAL 级别异常在 ASP.NET 页 (C#) |Microsoft Docs
author: rick-anderson
description: 在本教程中我们将了解如何显示一条友好、 信息性错误消息应在插入、 更新或删除操作期间会发生异常...
ms.author: aspnetcontent
manager: wpickett
ms.date: 07/17/2006
ms.topic: article
ms.assetid: 49d8a66c-3ea8-4087-839f-179d1d94512a
ms.technology: dotnet-webforms
msc.legacyurl: /web-forms/overview/data-access/editing-inserting-and-deleting-data/handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs
msc.type: authoredcontent
ms.openlocfilehash: c971b69605055e587aefe92fb4fc755176e6b53f
ms.sourcegitcommit: 953ff9ea4369f154d6fd0239599279ddd3280009
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 07/03/2018
ms.locfileid: "37393107"
---
<a name="handling-bll--and-dal-level-exceptions-in-an-aspnet-page-c"></a><span data-ttu-id="c4df4-103">处理 BLL 和 DAL 级别异常在 ASP.NET 页 (C#)</span><span class="sxs-lookup"><span data-stu-id="c4df4-103">Handling BLL- and DAL-Level Exceptions in an ASP.NET Page (C#)</span></span>
====================
<span data-ttu-id="c4df4-104">通过[Scott Mitchell](https://twitter.com/ScottOnWriting)</span><span class="sxs-lookup"><span data-stu-id="c4df4-104">by [Scott Mitchell](https://twitter.com/ScottOnWriting)</span></span>

<span data-ttu-id="c4df4-105">[下载示例应用程序](http://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_18_CS.exe)或[下载 PDF](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/datatutorial18cs1.pdf)</span><span class="sxs-lookup"><span data-stu-id="c4df4-105">[Download Sample App](http://download.microsoft.com/download/9/c/1/9c1d03ee-29ba-4d58-aa1a-f201dcc822ea/ASPNET_Data_Tutorial_18_CS.exe) or [Download PDF](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/datatutorial18cs1.pdf)</span></span>

> <span data-ttu-id="c4df4-106">在本教程中我们将了解如何显示一条友好、 信息性错误消息应在插入、 更新或删除操作的 ASP.NET 数据 Web 控件期间会发生异常。</span><span class="sxs-lookup"><span data-stu-id="c4df4-106">In this tutorial we will see how to display a friendly, informative error message should an exception occur during an insert, update, or delete operation of an ASP.NET data Web control.</span></span>


## <a name="introduction"></a><span data-ttu-id="c4df4-107">介绍</span><span class="sxs-lookup"><span data-stu-id="c4df4-107">Introduction</span></span>

<span data-ttu-id="c4df4-108">使用 ASP.NET web 应用程序使用分层应用程序体系结构中的数据的工作涉及以下三个常规步骤：</span><span class="sxs-lookup"><span data-stu-id="c4df4-108">Working with data from an ASP.NET web application using a tiered application architecture involves the following three general steps:</span></span>

1. <span data-ttu-id="c4df4-109">确定哪种业务逻辑层方法需要调用，以及要向其传递哪些参数值。</span><span class="sxs-lookup"><span data-stu-id="c4df4-109">Determine what method of the Business Logic Layer needs to be invoked and what parameter values to pass it.</span></span> <span data-ttu-id="c4df4-110">参数值可以是硬编码，以编程方式分配，或由用户输入的输入。</span><span class="sxs-lookup"><span data-stu-id="c4df4-110">The parameter values can be hard coded, programmatically-assigned, or inputs entered by the user.</span></span>
2. <span data-ttu-id="c4df4-111">调用方法。</span><span class="sxs-lookup"><span data-stu-id="c4df4-111">Invoke the method.</span></span>
3. <span data-ttu-id="c4df4-112">处理结果。</span><span class="sxs-lookup"><span data-stu-id="c4df4-112">Process the results.</span></span> <span data-ttu-id="c4df4-113">在调用返回数据的 BLL 方法时，这可能涉及到将数据绑定到数据 Web 控件。</span><span class="sxs-lookup"><span data-stu-id="c4df4-113">When calling a BLL method that returns data, this may involve binding the data to a data Web control.</span></span> <span data-ttu-id="c4df4-114">有关修改数据的 BLL 方法，这可能包括在执行某些操作基于返回值或适当地处理在步骤 2 中出现任何异常。</span><span class="sxs-lookup"><span data-stu-id="c4df4-114">For BLL methods that modify data, this may include performing some action based on a return value or gracefully handling any exception that arose in Step 2.</span></span>

<span data-ttu-id="c4df4-115">中可以看到[前一篇教程](examining-the-events-associated-with-inserting-updating-and-deleting-cs.md)，ObjectDataSource 和数据 Web 控件提供的扩展点的步骤 1 和 3。</span><span class="sxs-lookup"><span data-stu-id="c4df4-115">As we saw in the [previous tutorial](examining-the-events-associated-with-inserting-updating-and-deleting-cs.md), both the ObjectDataSource and the data Web controls provide extensibility points for Steps 1 and 3.</span></span> <span data-ttu-id="c4df4-116">GridView 中，例如，激发其`RowUpdating`事件之前将其字段值分配给其 ObjectDataSource`UpdateParameters`集合; 它`RowUpdated`ObjectDataSource 完成该操作后引发事件。</span><span class="sxs-lookup"><span data-stu-id="c4df4-116">The GridView, for example, fires its `RowUpdating` event prior to assigning its field values to its ObjectDataSource's `UpdateParameters` collection; its `RowUpdated` event is raised after the ObjectDataSource has completed the operation.</span></span>

<span data-ttu-id="c4df4-117">我们已经探讨了过程步骤 1 中激发并已全面了解如何使用它们以自定义的输入的参数或取消操作的事件。</span><span class="sxs-lookup"><span data-stu-id="c4df4-117">We've already examined the events that fire during Step 1 and have seen how they can be used to customize the input parameters or cancel the operation.</span></span> <span data-ttu-id="c4df4-118">在本教程中我们要将注意力转移到在操作完成后触发的事件。</span><span class="sxs-lookup"><span data-stu-id="c4df4-118">In this tutorial we'll turn our attention to the events that fire after the operation has completed.</span></span> <span data-ttu-id="c4df4-119">与我们可以除此之外，这些后级别事件处理程序确定在操作期间是否发生了异常和正常地处理在屏幕上显示一条友好、 信息性错误消息，而不是默认设置为标准的 ASP.NET异常页。</span><span class="sxs-lookup"><span data-stu-id="c4df4-119">With these post-level event handlers we can, among other things, determine if an exception occurred during the operation and handle it gracefully, displaying a friendly, informative error message on the screen rather than defaulting to the standard ASP.NET exception page.</span></span>

<span data-ttu-id="c4df4-120">为了说明使用这些后级别事件，让我们创建列出的产品可编辑的 GridView 中的页面。</span><span class="sxs-lookup"><span data-stu-id="c4df4-120">To illustrate working with these post-level events, let's create a page that lists the products in an editable GridView.</span></span> <span data-ttu-id="c4df4-121">更新产品，如果异常引发时我们 ASP.NET 页将显示一条短消息上面 GridView 说明出现问题。</span><span class="sxs-lookup"><span data-stu-id="c4df4-121">When updating a product, if an exception is raised our ASP.NET page will display a short message above the GridView explaining that a problem has occurred.</span></span> <span data-ttu-id="c4df4-122">让我们进入正题！</span><span class="sxs-lookup"><span data-stu-id="c4df4-122">Let's get started!</span></span>

## <a name="step-1-creating-an-editable-gridview-of-products"></a><span data-ttu-id="c4df4-123">步骤 1： 创建可编辑产品的 GridView</span><span class="sxs-lookup"><span data-stu-id="c4df4-123">Step 1: Creating an Editable GridView of Products</span></span>

<span data-ttu-id="c4df4-124">上一教程中我们创建可编辑的 GridView 与仅使用两个字段`ProductName`和`UnitPrice`。</span><span class="sxs-lookup"><span data-stu-id="c4df4-124">In the previous tutorial we created an editable GridView with just two fields, `ProductName` and `UnitPrice`.</span></span> <span data-ttu-id="c4df4-125">这需要创建的其他重载`ProductsBLL`类的`UpdateProduct`方法，即： 按相反的每个产品字段参数，才接受三个输入的参数 （该产品的名称、 单价和 ID）。</span><span class="sxs-lookup"><span data-stu-id="c4df4-125">This required creating an additional overload for the `ProductsBLL` class's `UpdateProduct` method, one that only accepted three input parameters (the product's name, unit price, and ID) as opposed a parameter for each product field.</span></span> <span data-ttu-id="c4df4-126">本教程中，让我们来练习此技术同样，创建可编辑的 GridView 显示产品的名称，每个单元、 单价和单位数量库存数量，但在要编辑的库存中仅允许的名称、 单价和单位。</span><span class="sxs-lookup"><span data-stu-id="c4df4-126">For this tutorial, let's practice this technique again, creating an editable GridView that displays the product's name, quantity per unit, unit price, and units in stock, but only allows the name, unit price, and units in stock to be edited.</span></span>

<span data-ttu-id="c4df4-127">为了适应这种情况下，我们需要的另一个重载`UpdateProduct`方法中，一个接受四个参数： 产品的名称、 单价、 量股票和 id。</span><span class="sxs-lookup"><span data-stu-id="c4df4-127">To accommodate this scenario we'll need another overload of the `UpdateProduct` method, one that accepts four parameters: the product's name, unit price, units in stock, and ID.</span></span> <span data-ttu-id="c4df4-128">添加以下方法`ProductsBLL`类：</span><span class="sxs-lookup"><span data-stu-id="c4df4-128">Add the following method to the `ProductsBLL` class:</span></span>


[!code-csharp[Main](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/samples/sample1.cs)]

<span data-ttu-id="c4df4-129">完成此方法中，我们就准备好创建允许进行编辑这四个特定产品字段的 ASP.NET 页。</span><span class="sxs-lookup"><span data-stu-id="c4df4-129">With this method complete, we're ready to create the ASP.NET page that allows for editing these four particular product fields.</span></span> <span data-ttu-id="c4df4-130">打开`ErrorHandling.aspx`页中`EditInsertDelete`文件夹，并在设计器中翻页添加 GridView。</span><span class="sxs-lookup"><span data-stu-id="c4df4-130">Open the `ErrorHandling.aspx` page in the `EditInsertDelete` folder and add a GridView to the page through the Designer.</span></span> <span data-ttu-id="c4df4-131">将 GridView 绑定到新的对象数据源，映射`Select()`方法`ProductsBLL`类的`GetProducts()`方法并`Update()`方法`UpdateProduct`刚创建的重载。</span><span class="sxs-lookup"><span data-stu-id="c4df4-131">Bind the GridView to a new ObjectDataSource, mapping the `Select()` method to the `ProductsBLL` class's `GetProducts()` method and the `Update()` method to the `UpdateProduct` overload just created.</span></span>


<span data-ttu-id="c4df4-132">[![使用接受四个输入的参数的 UpdateProduct 方法重载](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image2.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="c4df4-132">[![Use the UpdateProduct Method Overload That Accepts Four Input Parameters](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image2.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image1.png)</span></span>

<span data-ttu-id="c4df4-133">**图 1**： 使用`UpdateProduct`方法重载，接受四个输入参数 ([单击以查看实际尺寸的图像](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image3.png))</span><span class="sxs-lookup"><span data-stu-id="c4df4-133">**Figure 1**: Use the `UpdateProduct` Method Overload That Accepts Four Input Parameters ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image3.png))</span></span>


<span data-ttu-id="c4df4-134">这将创建与 ObjectDataSource`UpdateParameters`具有四个参数和字段与 GridView 每个产品字段的集合。</span><span class="sxs-lookup"><span data-stu-id="c4df4-134">This will create an ObjectDataSource with an `UpdateParameters` collection with four parameters and a GridView with a field for each of the product fields.</span></span> <span data-ttu-id="c4df4-135">ObjectDataSource 的声明性标记将分配`OldValuesParameterFormatString`属性值`original_{0}`，这将导致异常，因为我们的 BLL 类不预期输入的参数名为`original_productID`中传递。</span><span class="sxs-lookup"><span data-stu-id="c4df4-135">The ObjectDataSource's declarative markup assigns the `OldValuesParameterFormatString` property the value `original_{0}`, which will cause an exception since our BLL class's don't expect an input parameter named `original_productID` to be passed in.</span></span> <span data-ttu-id="c4df4-136">不要忘了删除此设置完全从声明性语法 (或将其设置为默认值为`{0}`)。</span><span class="sxs-lookup"><span data-stu-id="c4df4-136">Don't forget to remove this setting altogether from the declarative syntax (or set it to the default value, `{0}`).</span></span>

<span data-ttu-id="c4df4-137">接下来，削减 GridView，其中仅包含`ProductName`， `QuantityPerUnit`， `UnitPrice`，和`UnitsInStock`BoundFields。</span><span class="sxs-lookup"><span data-stu-id="c4df4-137">Next, pare down the GridView to include only the `ProductName`, `QuantityPerUnit`, `UnitPrice`, and `UnitsInStock` BoundFields.</span></span> <span data-ttu-id="c4df4-138">此外可以随时以应用你认为所必要的任何字段级别格式 (例如，更改`HeaderText`属性)。</span><span class="sxs-lookup"><span data-stu-id="c4df4-138">Also feel free to apply any field-level formatting you deem necessary (such as changing the `HeaderText` properties).</span></span>

<span data-ttu-id="c4df4-139">上一教程中我们介绍了如何设置格式`UnitPrice`BoundField 为货币在只读模式和编辑模式中。</span><span class="sxs-lookup"><span data-stu-id="c4df4-139">In the previous tutorial we looked at how to format the `UnitPrice` BoundField as a currency both in read-only mode and edit mode.</span></span> <span data-ttu-id="c4df4-140">让我们来做同一此处。</span><span class="sxs-lookup"><span data-stu-id="c4df4-140">Let's do the same here.</span></span> <span data-ttu-id="c4df4-141">回想一下，这需要设置 BoundField`DataFormatString`属性设置为`{0:c}`，将其`HtmlEncode`属性设置为`false`，并将其`ApplyFormatInEditMode`到`true`，如图 2 所示。</span><span class="sxs-lookup"><span data-stu-id="c4df4-141">Recall that this required setting the BoundField's `DataFormatString` property to `{0:c}`, its `HtmlEncode` property to `false`, and its `ApplyFormatInEditMode` to `true`, as shown in Figure 2.</span></span>


<span data-ttu-id="c4df4-142">[![将显示单价 BoundField 配置为一种货币](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image5.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image4.png)</span><span class="sxs-lookup"><span data-stu-id="c4df4-142">[![Configure the UnitPrice BoundField to Display as a Currency](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image5.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image4.png)</span></span>

<span data-ttu-id="c4df4-143">**图 2**： 配置`UnitPrice`显示为一种货币的 BoundField ([单击以查看实际尺寸的图像](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image6.png))</span><span class="sxs-lookup"><span data-stu-id="c4df4-143">**Figure 2**: Configure the `UnitPrice` BoundField to Display as a Currency ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image6.png))</span></span>


<span data-ttu-id="c4df4-144">格式设置`UnitPrice`因为编辑界面中的货币需要创建一个事件处理程序的 GridView`RowUpdating`货币格式将字符串分析成事件`decimal`值。</span><span class="sxs-lookup"><span data-stu-id="c4df4-144">Formatting the `UnitPrice` as a currency in the editing interface requires creating an event handler for the GridView's `RowUpdating` event that parses the currency-formatted string into a `decimal` value.</span></span> <span data-ttu-id="c4df4-145">请记住，`RowUpdating`最后一个教程中的事件处理程序还检查以确保用户提供`UnitPrice`值。</span><span class="sxs-lookup"><span data-stu-id="c4df4-145">Recall that the `RowUpdating` event handler from the last tutorial also checked to ensure that the user provided a `UnitPrice` value.</span></span> <span data-ttu-id="c4df4-146">但是，本教程中我们允许用户省略价格。</span><span class="sxs-lookup"><span data-stu-id="c4df4-146">However, for this tutorial let's allow the user to omit the price.</span></span>


[!code-csharp[Main](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/samples/sample2.cs)]

<span data-ttu-id="c4df4-147">我们 GridView 包括`QuantityPerUnit`BoundField，但此 BoundField 应仅出于显示目的，不应由用户可编辑。</span><span class="sxs-lookup"><span data-stu-id="c4df4-147">Our GridView includes a `QuantityPerUnit` BoundField, but this BoundField should be only for display purposes and should not be editable by the user.</span></span> <span data-ttu-id="c4df4-148">若要这样安排，只需设置 BoundFields'`ReadOnly`属性设置为`true`。</span><span class="sxs-lookup"><span data-stu-id="c4df4-148">To arrange this, simply set the BoundFields' `ReadOnly` property to `true`.</span></span>


<span data-ttu-id="c4df4-149">[![使 QuantityPerUnit BoundField 成为只读](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image8.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="c4df4-149">[![Make the QuantityPerUnit BoundField Read-Only](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image8.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image7.png)</span></span>

<span data-ttu-id="c4df4-150">**图 3**： 请`QuantityPerUnit`BoundField 只读的 ([单击以查看实际尺寸的图像](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image9.png))</span><span class="sxs-lookup"><span data-stu-id="c4df4-150">**Figure 3**: Make the `QuantityPerUnit` BoundField Read-Only ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image9.png))</span></span>


<span data-ttu-id="c4df4-151">最后，检查从 GridView 的智能标记启用编辑复选框。</span><span class="sxs-lookup"><span data-stu-id="c4df4-151">Finally, check the Enable Editing checkbox from the GridView's smart tag.</span></span> <span data-ttu-id="c4df4-152">完成这些步骤后`ErrorHandling.aspx`页面的设计器应类似于图 4。</span><span class="sxs-lookup"><span data-stu-id="c4df4-152">After completing these steps the `ErrorHandling.aspx` page's Designer should look similar to Figure 4.</span></span>


<span data-ttu-id="c4df4-153">[![删除所有但时需要 BoundFields 并检查编辑复选框启用](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image11.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image10.png)</span><span class="sxs-lookup"><span data-stu-id="c4df4-153">[![Remove All But the Needed BoundFields and Check the Enable Editing Checkbox](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image11.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image10.png)</span></span>

<span data-ttu-id="c4df4-154">**图 4**： 删除以外的所有所需 BoundFields 并选中启用编辑复选框 ([单击以查看实际尺寸的图像](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image12.png))</span><span class="sxs-lookup"><span data-stu-id="c4df4-154">**Figure 4**: Remove All But the Needed BoundFields and Check the Enable Editing Checkbox ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image12.png))</span></span>


<span data-ttu-id="c4df4-155">现在我们有一系列的产品的所有`ProductName`， `QuantityPerUnit`， `UnitPrice`，和`UnitsInStock`字段; 但是，仅`ProductName`， `UnitPrice`，和`UnitsInStock`可编辑字段。</span><span class="sxs-lookup"><span data-stu-id="c4df4-155">At this point we have a list of all of the products' `ProductName`, `QuantityPerUnit`, `UnitPrice`, and `UnitsInStock` fields; however, only the `ProductName`, `UnitPrice`, and `UnitsInStock` fields can be edited.</span></span>


<span data-ttu-id="c4df4-156">[![用户现在可以轻松地编辑产品的名称、 价格和库存字段中的单元](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image14.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="c4df4-156">[![Users Can Now Easily Edit Products' Names, Prices, and Units In Stock Fields](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image14.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image13.png)</span></span>

<span data-ttu-id="c4df4-157">**图 5**： 用户可立即轻松地编辑产品的名称、 价格和库存字段中的单元 ([单击以查看实际尺寸的图像](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image15.png))</span><span class="sxs-lookup"><span data-stu-id="c4df4-157">**Figure 5**: Users Can Now Easily Edit Products' Names, Prices, and Units In Stock Fields ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image15.png))</span></span>


## <a name="step-2-gracefully-handling-dal-level-exceptions"></a><span data-ttu-id="c4df4-158">步骤 2： 正常处理 DAL 级别的异常</span><span class="sxs-lookup"><span data-stu-id="c4df4-158">Step 2: Gracefully Handling DAL-Level Exceptions</span></span>

<span data-ttu-id="c4df4-159">尽管我们可编辑的 GridView 浅显有效用户时输入的已编辑的产品的名称、 价格和库存数量的合法值，输入非法值会导致异常。</span><span class="sxs-lookup"><span data-stu-id="c4df4-159">While our editable GridView works wonderfully when users enter legal values for the edited product's name, price, and units in stock, entering illegal values results in an exception.</span></span> <span data-ttu-id="c4df4-160">例如，省略`ProductName`值的原因[NoNullAllowedException](https://msdn.microsoft.com/library/default.asp?url=/library/cpref/html/frlrfsystemdatanonullallowedexceptionclasstopic.asp)以来引发`ProductName`中的属性`ProdcutsRow`类具有其`AllowDBNull`属性设置为`false`; 如果数据库已关闭，`SqlException`尝试连接到数据库时，TableAdapter 将引发。</span><span class="sxs-lookup"><span data-stu-id="c4df4-160">For example, omitting the `ProductName` value causes a [NoNullAllowedException](https://msdn.microsoft.com/library/default.asp?url=/library/cpref/html/frlrfsystemdatanonullallowedexceptionclasstopic.asp) to be thrown since the `ProductName` property in the `ProdcutsRow` class has its `AllowDBNull` property set to `false`; if the database is down, a `SqlException` will be thrown by the TableAdapter when attempting to connect to the database.</span></span> <span data-ttu-id="c4df4-161">不采取任何措施，这些异常向上冒泡从数据访问层业务逻辑层，则 ASP.NET 页中，最后到 ASP.NET 运行时。</span><span class="sxs-lookup"><span data-stu-id="c4df4-161">Without taking any action, these exceptions bubble up from the Data Access Layer to the Business Logic Layer, then to the ASP.NET page, and finally to the ASP.NET runtime.</span></span>

<span data-ttu-id="c4df4-162">具体取决于如何配置 web 应用程序以及是否正在访问应用程序从`localhost`，未处理的异常可能会导致常规服务器错误页、 详细的错误报表或用户友好的网页。</span><span class="sxs-lookup"><span data-stu-id="c4df4-162">Depending on how your web application is configured and whether or not you're visiting the application from `localhost`, an unhandled exception can result in either a generic server-error page, a detailed error report, or a user-friendly web page.</span></span> <span data-ttu-id="c4df4-163">请参阅[Web 应用程序中的错误处理 ASP.NET](http://www.15seconds.com/issue/030102.htm)并[customErrors 元素](https://msdn.microsoft.com/library/h0hfz6fc(VS.80).aspx)为 ASP.NET 运行时如何响应未捕获的异常的详细信息。</span><span class="sxs-lookup"><span data-stu-id="c4df4-163">See [Web Application Error Handling in ASP.NET](http://www.15seconds.com/issue/030102.htm) and the [customErrors Element](https://msdn.microsoft.com/library/h0hfz6fc(VS.80).aspx) for more information on how the ASP.NET runtime responds to an uncaught exception.</span></span>

<span data-ttu-id="c4df4-164">图 6 显示了屏幕时尝试将产品更新而无需指定遇到`ProductName`值。</span><span class="sxs-lookup"><span data-stu-id="c4df4-164">Figure 6 shows the screen encountered when attempting to update a product without specifying the `ProductName` value.</span></span> <span data-ttu-id="c4df4-165">这是通过显示详细的错误报告的默认`localhost`。</span><span class="sxs-lookup"><span data-stu-id="c4df4-165">This is the default detailed error report displayed when coming through `localhost`.</span></span>


<span data-ttu-id="c4df4-166">[![省略产品的名称将显示异常详细信息](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image17.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image16.png)</span><span class="sxs-lookup"><span data-stu-id="c4df4-166">[![Omitting the Product's Name Will Display Exception Details](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image17.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image16.png)</span></span>

<span data-ttu-id="c4df4-167">**图 6**： 忽略该产品的名称将显示异常详细信息 ([单击以查看实际尺寸的图像](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image18.png))</span><span class="sxs-lookup"><span data-stu-id="c4df4-167">**Figure 6**: Omitting the Product's Name Will Display Exception Details ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image18.png))</span></span>


<span data-ttu-id="c4df4-168">虽然测试应用程序时，此类异常详细信息很有用，向最终用户显示此类屏幕在遇到异常时是不太理想。</span><span class="sxs-lookup"><span data-stu-id="c4df4-168">While such exception details are helpful when testing an application, presenting an end user with such a screen in the face of an exception is less than ideal.</span></span> <span data-ttu-id="c4df4-169">最终用户可能不知道什么`NoNullAllowedException`是或原因所致。</span><span class="sxs-lookup"><span data-stu-id="c4df4-169">An end user likely doesn't know what a `NoNullAllowedException` is or why it was caused.</span></span> <span data-ttu-id="c4df4-170">更好的方法是向用户显示一条说明时出现问题尝试更新的产品的更加友好的用户消息。</span><span class="sxs-lookup"><span data-stu-id="c4df4-170">A better approach is to present the user with a more user-friendly message explaining that there were problems attempting to update the product.</span></span>

<span data-ttu-id="c4df4-171">如果执行操作时出现异常，ObjectDataSource 和数据 Web 控件中的后续级别事件提供一种方法对其进行检测并取消从向上冒泡到 ASP.NET 运行时异常。</span><span class="sxs-lookup"><span data-stu-id="c4df4-171">If an exception occurs when performing the operation, the post-level events in both the ObjectDataSource and the data Web control provide a means to detect it and cancel the exception from bubbling up to the ASP.NET runtime.</span></span> <span data-ttu-id="c4df4-172">对于我们的示例，让我们将创建为 GridView 的事件处理程序`RowUpdated`确定异常触发，如果是这样，在标签 Web 控件中显示异常详细信息的事件。</span><span class="sxs-lookup"><span data-stu-id="c4df4-172">For our example, let's create an event handler for the GridView's `RowUpdated` event that determines if an exception has fired and, if so, displays the exception details in a Label Web control.</span></span>

<span data-ttu-id="c4df4-173">首先，将标签添加到 ASP.NET 页上，设置其`ID`属性设置为`ExceptionDetails`并清除其`Text`属性。</span><span class="sxs-lookup"><span data-stu-id="c4df4-173">Start by adding a Label to the ASP.NET page, setting its `ID` property to `ExceptionDetails` and clearing out its `Text` property.</span></span> <span data-ttu-id="c4df4-174">若要绘制到此消息的用户的关注，设置其`CssClass`属性设置为`Warning`，它是我们添加到一个 CSS 类`Styles.css`上一教程中的文件。</span><span class="sxs-lookup"><span data-stu-id="c4df4-174">In order to draw the user's eye to this message, set its `CssClass` property to `Warning`, which is a CSS class we added to the `Styles.css` file in the previous tutorial.</span></span> <span data-ttu-id="c4df4-175">回想一下，此 CSS 类会导致将标签的文本以红色、 斜体、 粗体、 特大型字体显示。</span><span class="sxs-lookup"><span data-stu-id="c4df4-175">Recall that this CSS class causes the Label's text to be displayed in a red, italic, bold, extra large font.</span></span>


<span data-ttu-id="c4df4-176">[![向页面添加一个标签 Web 控件](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image20.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="c4df4-176">[![Add a Label Web Control to the Page](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image20.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image19.png)</span></span>

<span data-ttu-id="c4df4-177">**图 7**： 向页面添加一个标签 Web 控件 ([单击以查看实际尺寸的图像](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image21.png))</span><span class="sxs-lookup"><span data-stu-id="c4df4-177">**Figure 7**: Add a Label Web Control to the Page ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image21.png))</span></span>


<span data-ttu-id="c4df4-178">由于我们希望此标签 Web 控件可见仅立即后发生了异常，设置其`Visible`属性设置为 false 在`Page_Load`事件处理程序：</span><span class="sxs-lookup"><span data-stu-id="c4df4-178">Since we want this Label Web control to be visible only immediately after an exception has occurred, set its `Visible` property to false in the `Page_Load` event handler:</span></span>


[!code-csharp[Main](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/samples/sample3.cs)]

<span data-ttu-id="c4df4-179">使用此代码，第一次页面访问和后续回发`ExceptionDetails`控件将具有其`Visible`属性设置为`false`。</span><span class="sxs-lookup"><span data-stu-id="c4df4-179">With this code, on the first page visit and subsequent postbacks the `ExceptionDetails` control will have its `Visible` property set to `false`.</span></span> <span data-ttu-id="c4df4-180">DAL 或 BLL 级别异常，这可以检测到 GridView 中遇到`RowUpdated`事件处理程序，我们将把`ExceptionDetails`控件的`Visible`属性设为 true。</span><span class="sxs-lookup"><span data-stu-id="c4df4-180">In the face of a DAL- or BLL-level exception, which we can detect in the GridView's `RowUpdated` event handler, we will set the `ExceptionDetails` control's `Visible` property to true.</span></span> <span data-ttu-id="c4df4-181">因为 Web 控件事件处理程序后会发生`Page_Load`页面生命周期中的事件处理程序，将显示标签。</span><span class="sxs-lookup"><span data-stu-id="c4df4-181">Since Web control event handlers occur after the `Page_Load` event handler in the page lifecycle, the Label will be shown.</span></span> <span data-ttu-id="c4df4-182">但是，在下一个回发`Page_Load`事件处理程序将恢复`Visible`属性改回`false`，再次从视图中隐藏。</span><span class="sxs-lookup"><span data-stu-id="c4df4-182">However, on the next postback, the `Page_Load` event handler will revert the `Visible` property back to `false`, hiding it from view again.</span></span>

> [!NOTE]
> <span data-ttu-id="c4df4-183">或者，我们可以删除设置的必要性`ExceptionDetails`控件的`Visible`属性中的`Page_Load`通过将分配其`Visible`属性`false`中的声明性语法和禁用 （设置其其视图状态`EnableViewState`属性设置为`false`)。</span><span class="sxs-lookup"><span data-stu-id="c4df4-183">Alternatively, we could remove the necessity for setting the `ExceptionDetails` control's `Visible` property in `Page_Load` by assigning its `Visible` property `false` in the declarative syntax and disabling its view state (setting its `EnableViewState` property to `false`).</span></span> <span data-ttu-id="c4df4-184">我们将在以后的教程中使用此另一种方法。</span><span class="sxs-lookup"><span data-stu-id="c4df4-184">We'll use this alternative approach in a future tutorial.</span></span>


<span data-ttu-id="c4df4-185">下一步是为 GridView 的创建事件处理程序添加的标签控件，与`RowUpdated`事件。</span><span class="sxs-lookup"><span data-stu-id="c4df4-185">With the Label control added, our next step is to create the event handler for the GridView's `RowUpdated` event.</span></span> <span data-ttu-id="c4df4-186">在设计器中选择 GridView，转到属性窗口中，然后单击闪电形图标，列出 GridView 的事件。</span><span class="sxs-lookup"><span data-stu-id="c4df4-186">Select the GridView in the Designer, go to the Properties window, and click the lightning bolt icon, listing the GridView's events.</span></span> <span data-ttu-id="c4df4-187">应该已有的条目的 GridView 的`RowUpdating`事件，如我们前面在本教程中创建此事件的事件处理程序。</span><span class="sxs-lookup"><span data-stu-id="c4df4-187">There should already be an entry there for the GridView's `RowUpdating` event, as we created an event handler for this event earlier in this tutorial.</span></span> <span data-ttu-id="c4df4-188">创建事件处理程序`RowUpdated`以及事件。</span><span class="sxs-lookup"><span data-stu-id="c4df4-188">Create an event handler for the `RowUpdated` event as well.</span></span>


![GridView 的 RowUpdated 事件创建事件处理程序](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image22.png)

<span data-ttu-id="c4df4-190">**图 8**： 创建 GridView 的事件处理程序`RowUpdated`事件</span><span class="sxs-lookup"><span data-stu-id="c4df4-190">**Figure 8**: Create an Event Handler for the GridView's `RowUpdated` Event</span></span>


> [!NOTE]
> <span data-ttu-id="c4df4-191">此外可以在代码隐藏类文件的顶部创建通过下拉列表的事件处理程序。</span><span class="sxs-lookup"><span data-stu-id="c4df4-191">You can also create the event handler through the drop-down lists at the top of the code-behind class file.</span></span> <span data-ttu-id="c4df4-192">从左侧的下拉列表中选择 GridView 和`RowUpdated`从右侧的一个事件。</span><span class="sxs-lookup"><span data-stu-id="c4df4-192">Select the GridView from the drop-down list on the left and the `RowUpdated` event from the one on the right.</span></span>


<span data-ttu-id="c4df4-193">创建此事件处理程序后，将以下代码添加到 ASP.NET 页面的代码隐藏类中：</span><span class="sxs-lookup"><span data-stu-id="c4df4-193">Creating this event handler will add the following code to the ASP.NET page's code-behind class:</span></span>


[!code-csharp[Main](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/samples/sample4.cs)]

<span data-ttu-id="c4df4-194">此事件处理程序的第二个输入的参数是类型的对象[GridViewUpdatedEventArgs](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridviewupdatedeventargs.aspx)，其中包含用于处理异常的感兴趣的三个属性：</span><span class="sxs-lookup"><span data-stu-id="c4df4-194">This event handler's second input parameter is an object of type [GridViewUpdatedEventArgs](https://msdn.microsoft.com/library/system.web.ui.webcontrols.gridviewupdatedeventargs.aspx), which has three properties of interest for handling exceptions:</span></span>

- <span data-ttu-id="c4df4-195">`Exception` 对引发的异常; 的引用如果已不引发任何异常，此属性将具有的值 `null`</span><span class="sxs-lookup"><span data-stu-id="c4df4-195">`Exception` a reference to the thrown exception; if no exception has been thrown, this property will have a value of `null`</span></span>
- <span data-ttu-id="c4df4-196">`ExceptionHandled` 一个布尔值，指示是否在处理异常`RowUpdated`事件处理程序; 如果`false`（默认值），例外情况是重新引发，ASP.NET 运行时决定沸沸扬扬</span><span class="sxs-lookup"><span data-stu-id="c4df4-196">`ExceptionHandled` a Boolean value that indicates whether or not the exception was handled in the `RowUpdated` event handler; if `false` (the default), the exception is re-thrown, percolating up to the ASP.NET runtime</span></span>
- <span data-ttu-id="c4df4-197">`KeepInEditMode` 如果设置为`true`编辑过的 GridView 行保持在编辑模式下; 如果`false`（默认值），GridView 行会还原为其只读模式</span><span class="sxs-lookup"><span data-stu-id="c4df4-197">`KeepInEditMode` if set to `true` the edited GridView row remains in edit mode; if `false` (the default), the GridView row reverts back to its read-only mode</span></span>

<span data-ttu-id="c4df4-198">我们的代码，然后，应检查以查看是否`Exception`不是`null`，这意味着时执行操作时引发了异常。</span><span class="sxs-lookup"><span data-stu-id="c4df4-198">Our code, then, should check to see if `Exception` is not `null`, meaning that an exception was raised while performing the operation.</span></span> <span data-ttu-id="c4df4-199">如果是这样，我们希望：</span><span class="sxs-lookup"><span data-stu-id="c4df4-199">If this is the case, we want to:</span></span>

- <span data-ttu-id="c4df4-200">显示用户友好消息`ExceptionDetails`标签</span><span class="sxs-lookup"><span data-stu-id="c4df4-200">Display a user-friendly message in the `ExceptionDetails` Label</span></span>
- <span data-ttu-id="c4df4-201">指示已处理该异常</span><span class="sxs-lookup"><span data-stu-id="c4df4-201">Indicate that the exception was handled</span></span>
- <span data-ttu-id="c4df4-202">GridView 行保留在编辑模式下</span><span class="sxs-lookup"><span data-stu-id="c4df4-202">Keep the GridView row in edit mode</span></span>

<span data-ttu-id="c4df4-203">此下面的代码来实现这些目标：</span><span class="sxs-lookup"><span data-stu-id="c4df4-203">This following code accomplishes these objectives:</span></span>


[!code-csharp[Main](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/samples/sample5.cs)]

<span data-ttu-id="c4df4-204">此事件处理程序首先会检查是否`e.Exception`是`null`。</span><span class="sxs-lookup"><span data-stu-id="c4df4-204">This event handler begins by checking to see if `e.Exception` is `null`.</span></span> <span data-ttu-id="c4df4-205">如果不是，`ExceptionDetails`标签的`Visible`属性设置为`true`并将其`Text`属性设置为"时出现问题更新产品。"</span><span class="sxs-lookup"><span data-stu-id="c4df4-205">If it's not, the `ExceptionDetails` Label's `Visible` property is set to `true` and its `Text` property to "There was a problem updating the product."</span></span> <span data-ttu-id="c4df4-206">实际引发的异常的详细信息位于`e.Exception`对象的`InnerException`属性。</span><span class="sxs-lookup"><span data-stu-id="c4df4-206">The details of the actual exception that was thrown reside in the `e.Exception` object's `InnerException` property.</span></span> <span data-ttu-id="c4df4-207">此内部异常进行检查; 如果它是特定类型，其他的、 有帮助的消息追加到`ExceptionDetails`标签的`Text`属性。</span><span class="sxs-lookup"><span data-stu-id="c4df4-207">This inner exception is examined and, if it is of a particular type, an additional, helpful message is appended to the `ExceptionDetails` Label's `Text` property.</span></span> <span data-ttu-id="c4df4-208">最后，`ExceptionHandled`并`KeepInEditMode`属性均设置为`true`。</span><span class="sxs-lookup"><span data-stu-id="c4df4-208">Lastly, the `ExceptionHandled` and `KeepInEditMode` properties are both set to `true`.</span></span>

<span data-ttu-id="c4df4-209">图 9 显示了此页的屏幕截图时省略产品; 的名称图 10 显示了结果，如果输入非法`UnitPrice`值 (-50)。</span><span class="sxs-lookup"><span data-stu-id="c4df4-209">Figure 9 shows a screen shot of this page when omitting the name of the product; Figure 10 shows the results when entering an illegal `UnitPrice` value (-50).</span></span>


<span data-ttu-id="c4df4-210">[![ProductName BoundField 必须包含值](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image24.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image23.png)</span><span class="sxs-lookup"><span data-stu-id="c4df4-210">[![The ProductName BoundField Must Contain a Value](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image24.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image23.png)</span></span>

<span data-ttu-id="c4df4-211">**图 9**: `ProductName` BoundField 必须包含值 ([单击以查看实际尺寸的图像](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image25.png))</span><span class="sxs-lookup"><span data-stu-id="c4df4-211">**Figure 9**: The `ProductName` BoundField Must Contain a Value ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image25.png))</span></span>


<span data-ttu-id="c4df4-212">[![负单价值是不允许](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image27.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image26.png)</span><span class="sxs-lookup"><span data-stu-id="c4df4-212">[![Negative UnitPrice Values are Not Allowed](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image27.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image26.png)</span></span>

<span data-ttu-id="c4df4-213">**图 10**： 负`UnitPrice`的值为不允许 ([单击以查看实际尺寸的图像](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image28.png))</span><span class="sxs-lookup"><span data-stu-id="c4df4-213">**Figure 10**: Negative `UnitPrice` Values are Not Allowed ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image28.png))</span></span>


<span data-ttu-id="c4df4-214">通过设置`e.ExceptionHandled`属性设置为`true`，则`RowUpdated`事件处理程序已指明它已处理异常。</span><span class="sxs-lookup"><span data-stu-id="c4df4-214">By setting the `e.ExceptionHandled` property to `true`, the `RowUpdated` event handler has indicated that it has handled the exception.</span></span> <span data-ttu-id="c4df4-215">因此，该异常不会传播到 ASP.NET 运行时。</span><span class="sxs-lookup"><span data-stu-id="c4df4-215">Therefore, the exception won't propagate up to the ASP.NET runtime.</span></span>

> [!NOTE]
> <span data-ttu-id="c4df4-216">图 9 和 10 显示妥善的方式来处理由于无效的用户输入而引发的异常。</span><span class="sxs-lookup"><span data-stu-id="c4df4-216">Figures 9 and 10 show a graceful way to handle exceptions raised due to invalid user input.</span></span> <span data-ttu-id="c4df4-217">理想情况下，不过，此类的输入无效将永远不会市场宣传业务逻辑层的初衷，因为 ASP.NET 页中，应确保在调用之前的用户的输入是否有效`ProductsBLL`类的`UpdateProduct`方法。</span><span class="sxs-lookup"><span data-stu-id="c4df4-217">Ideally, though, such invalid input will never reach the Business Logic Layer in the first place, as the ASP.NET page should ensure that the user's inputs are valid before invoking the `ProductsBLL` class's `UpdateProduct` method.</span></span> <span data-ttu-id="c4df4-218">在我们下一教程中我们将了解如何将验证控件添加到要确保提交到业务逻辑层的数据的编辑和插入接口符合业务规则。</span><span class="sxs-lookup"><span data-stu-id="c4df4-218">In our next tutorial we'll see how to add validation controls to the editing and inserting interfaces to ensure that the data submitted to the Business Logic Layer conforms to the business rules.</span></span> <span data-ttu-id="c4df4-219">验证控件不只是防止调用`UpdateProduct`方法，直到用户提供的数据有效，但还提供用于标识数据输入问题的信息更丰富的用户体验。</span><span class="sxs-lookup"><span data-stu-id="c4df4-219">The validation controls not only prevent the invocation of the `UpdateProduct` method until the user-supplied data is valid, but also provide a more informative user experience for identifying data entry problems.</span></span>


## <a name="step-3-gracefully-handling-bll-level-exceptions"></a><span data-ttu-id="c4df4-220">步骤 3： 正常处理 BLL 级别的异常</span><span class="sxs-lookup"><span data-stu-id="c4df4-220">Step 3: Gracefully Handling BLL-Level Exceptions</span></span>

<span data-ttu-id="c4df4-221">插入时，更新或删除数据，数据访问层可能会引发在遇到与数据相关的错误时出现异常。</span><span class="sxs-lookup"><span data-stu-id="c4df4-221">When inserting, updating, or deleting data, the Data Access Layer may throw an exception in the face of a data-related error.</span></span> <span data-ttu-id="c4df4-222">数据库可能处于脱机状态、 所需的数据库表列可能不具有指定的值或表级约束可能违反了。</span><span class="sxs-lookup"><span data-stu-id="c4df4-222">The database may be offline, a required database table column might not have had a value specified, or a table-level constraint may have been violated.</span></span> <span data-ttu-id="c4df4-223">除了严格与数据相关的异常，业务逻辑层可以使用异常以指示何时违反了业务规则。</span><span class="sxs-lookup"><span data-stu-id="c4df4-223">In addition to strictly data-related exceptions, the Business Logic Layer can use exceptions to indicate when business rules have been violated.</span></span> <span data-ttu-id="c4df4-224">在中[创建业务逻辑层](../introduction/creating-a-business-logic-layer-cs.md)教程中，例如，我们添加到原始业务规则检查`UpdateProduct`重载。</span><span class="sxs-lookup"><span data-stu-id="c4df4-224">In the [Creating a Business Logic Layer](../introduction/creating-a-business-logic-layer-cs.md) tutorial, for example, we added a business rule check to the original `UpdateProduct` overload.</span></span> <span data-ttu-id="c4df4-225">具体而言，如果用户已将产品标记为停止使用，我们需要产品不是唯一一个其供应商提供。</span><span class="sxs-lookup"><span data-stu-id="c4df4-225">Specifically, if the user was marking a product as discontinued, we required that the product not be the only one provided by its supplier.</span></span> <span data-ttu-id="c4df4-226">如果违反了这种情况，`ApplicationException`抛出。</span><span class="sxs-lookup"><span data-stu-id="c4df4-226">If this condition was violated, an `ApplicationException` was thrown.</span></span>

<span data-ttu-id="c4df4-227">有关`UpdateProduct`重载创建在本教程中，让我们添加的业务规则，禁止`UnitPrice`字段从设置为新值的两倍以上的原始`UnitPrice`值。</span><span class="sxs-lookup"><span data-stu-id="c4df4-227">For the `UpdateProduct` overload created in this tutorial, let's add a business rule that prohibits the `UnitPrice` field from being set to a new value that's more than twice the original `UnitPrice` value.</span></span> <span data-ttu-id="c4df4-228">若要实现此目的，调整`UpdateProduct`重载，以便它来执行此检查并引发`ApplicationException`如果违反该规则。</span><span class="sxs-lookup"><span data-stu-id="c4df4-228">To accomplish this, adjust the `UpdateProduct` overload so that it performs this check and throws an `ApplicationException` if the rule is violated.</span></span> <span data-ttu-id="c4df4-229">更新后的方法如下所示：</span><span class="sxs-lookup"><span data-stu-id="c4df4-229">The updated method follows:</span></span>


[!code-csharp[Main](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/samples/sample6.cs)]

<span data-ttu-id="c4df4-230">此更改是两次以上的现有价格的任何价格更新将导致`ApplicationException`引发。</span><span class="sxs-lookup"><span data-stu-id="c4df4-230">With this change, any price update that is more than twice the existing price will cause an `ApplicationException` to be thrown.</span></span> <span data-ttu-id="c4df4-231">就像从 DAL，此 BLL 引发所引发的异常`ApplicationException`可以检测到并且在 GridView 中处理`RowUpdated`事件处理程序。</span><span class="sxs-lookup"><span data-stu-id="c4df4-231">Just like the exception raised from the DAL, this BLL-raised `ApplicationException` can be detected and handled in the GridView's `RowUpdated` event handler.</span></span> <span data-ttu-id="c4df4-232">事实上，`RowUpdated`事件处理程序的代码编写的如将正确检测到此异常并显示`ApplicationException`的`Message`属性值。</span><span class="sxs-lookup"><span data-stu-id="c4df4-232">In fact, the `RowUpdated` event handler's code, as written, will correctly detect this exception and display the `ApplicationException`'s `Message` property value.</span></span> <span data-ttu-id="c4df4-233">图 11 显示了屏幕快照时用户尝试更新 Chai 的价格为 50.00 美元，这是多个双精度 19.95 美元及其当前股价。</span><span class="sxs-lookup"><span data-stu-id="c4df4-233">Figure 11 shows a screen shot when a user attempts to update the price of Chai to $50.00, which is more than double its current price of $19.95.</span></span>


<span data-ttu-id="c4df4-234">[![业务规则不允许产品的价格一倍以上的价格上调](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image30.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image29.png)</span><span class="sxs-lookup"><span data-stu-id="c4df4-234">[![The Business Rules Disallow Price Increases That More Than Double a Product's Price](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image30.png)](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image29.png)</span></span>

<span data-ttu-id="c4df4-235">**图 11**: 业务规则禁止产品的价格一倍以上的价格增加 ([单击以查看实际尺寸的图像](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image31.png))</span><span class="sxs-lookup"><span data-stu-id="c4df4-235">**Figure 11**: The Business Rules Disallow Price Increases That More Than Double a Product's Price ([Click to view full-size image](handling-bll-and-dal-level-exceptions-in-an-asp-net-page-cs/_static/image31.png))</span></span>


> [!NOTE]
> <span data-ttu-id="c4df4-236">理想情况下我们的业务逻辑规则进行重构共`UpdateProduct`方法重载并进入一种常用方法。</span><span class="sxs-lookup"><span data-stu-id="c4df4-236">Ideally our business logic rules would be refactored out of the `UpdateProduct` method overloads and into a common method.</span></span> <span data-ttu-id="c4df4-237">这是留给大家练练手为读取器。</span><span class="sxs-lookup"><span data-stu-id="c4df4-237">This is left as an exercise for the reader.</span></span>


## <a name="summary"></a><span data-ttu-id="c4df4-238">总结</span><span class="sxs-lookup"><span data-stu-id="c4df4-238">Summary</span></span>

<span data-ttu-id="c4df4-239">在插入、 更新和删除操作，数据 Web 控件和所涉及对象的数据源触发前和后级别事件的书档实际操作。</span><span class="sxs-lookup"><span data-stu-id="c4df4-239">During inserting, updating, and deleting operations, both the data Web control and the ObjectDataSource involved fire pre- and post-level events that bookend the actual operation.</span></span> <span data-ttu-id="c4df4-240">正如我们看到在本教程并前一次时使用的可编辑的 GridView GridView`RowUpdating`事件触发时后, 跟 ObjectDataSource 的`Updating`事件，此时 update 命令对 ObjectDataSource 的基础对象。</span><span class="sxs-lookup"><span data-stu-id="c4df4-240">As we saw in this tutorial and the preceding one, when working with an editable GridView the GridView's `RowUpdating` event fires, followed by the ObjectDataSource's `Updating` event, at which point the update command is made to the ObjectDataSource's underlying object.</span></span> <span data-ttu-id="c4df4-241">操作完成后，ObjectDataSource 的后`Updated`事件触发时后, 跟 GridView 的`RowUpdated`事件。</span><span class="sxs-lookup"><span data-stu-id="c4df4-241">After the operation has completed, the ObjectDataSource's `Updated` event fires, followed by the GridView's `RowUpdated` event.</span></span>

<span data-ttu-id="c4df4-242">我们可以创建以自定义的输入的参数预级别的事件，或者为了检查和响应操作的结果后级别的事件的事件处理程序。</span><span class="sxs-lookup"><span data-stu-id="c4df4-242">We can create event handlers for the pre-level events in order to customize the input parameters or for the post-level events in order to inspect and respond to the operation's results.</span></span> <span data-ttu-id="c4df4-243">后级别事件处理程序通常用于检测是否在操作期间发生了异常。</span><span class="sxs-lookup"><span data-stu-id="c4df4-243">Post-level event handlers are most commonly used to detect whether an exception occurred during the operation.</span></span> <span data-ttu-id="c4df4-244">遇到异常，这些后级别事件处理程序可以根据需要处理上其自己的异常。</span><span class="sxs-lookup"><span data-stu-id="c4df4-244">In the face of an exception, these post-level event handlers can optionally handle the exception on their own.</span></span> <span data-ttu-id="c4df4-245">在本教程中我们已了解如何通过显示友好的错误消息来处理此类异常。</span><span class="sxs-lookup"><span data-stu-id="c4df4-245">In this tutorial we saw how to handle such an exception by displaying a friendly error message.</span></span>

<span data-ttu-id="c4df4-246">在下一教程中，我们将了解如何降低因数据格式设置问题的异常的可能性 (例如输入为负`UnitPrice`)。</span><span class="sxs-lookup"><span data-stu-id="c4df4-246">In the next tutorial we'll see how to lessen the likelihood of exceptions arising from data formatting issues (such as entering a negative `UnitPrice`).</span></span> <span data-ttu-id="c4df4-247">具体而言，我们将介绍如何向编辑和插入界面添加验证控件。</span><span class="sxs-lookup"><span data-stu-id="c4df4-247">Specifically, we'll look at how to add validation controls to the editing and inserting interfaces.</span></span>

<span data-ttu-id="c4df4-248">快乐编程 ！</span><span class="sxs-lookup"><span data-stu-id="c4df4-248">Happy Programming!</span></span>

## <a name="about-the-author"></a><span data-ttu-id="c4df4-249">关于作者</span><span class="sxs-lookup"><span data-stu-id="c4df4-249">About the Author</span></span>

<span data-ttu-id="c4df4-250">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml)的七个部 asp/ASP.NET 书籍并创办了作者[4GuysFromRolla.com](http://www.4guysfromrolla.com)，自 1998 年以来一直致力于 Microsoft Web 技术。</span><span class="sxs-lookup"><span data-stu-id="c4df4-250">[Scott Mitchell](http://www.4guysfromrolla.com/ScottMitchell.shtml), author of seven ASP/ASP.NET books and founder of [4GuysFromRolla.com](http://www.4guysfromrolla.com), has been working with Microsoft Web technologies since 1998.</span></span> <span data-ttu-id="c4df4-251">Scott 是独立的顾问、 培训师和编写器。</span><span class="sxs-lookup"><span data-stu-id="c4df4-251">Scott works as an independent consultant, trainer, and writer.</span></span> <span data-ttu-id="c4df4-252">他最新著作是[ *Sams Teach 自己 ASP.NET 2.0 24 小时内*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco)。</span><span class="sxs-lookup"><span data-stu-id="c4df4-252">His latest book is [*Sams Teach Yourself ASP.NET 2.0 in 24 Hours*](https://www.amazon.com/exec/obidos/ASIN/0672327384/4guysfromrollaco).</span></span> <span data-ttu-id="c4df4-253">他可以到达[ mitchell@4GuysFromRolla.com。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="c4df4-253">He can be reached at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span> <span data-ttu-id="c4df4-254">或通过他的博客，其中，请参阅[ http://ScottOnWriting.NET ](http://ScottOnWriting.NET)。</span><span class="sxs-lookup"><span data-stu-id="c4df4-254">or via his blog, which can be found at [http://ScottOnWriting.NET](http://ScottOnWriting.NET).</span></span>

## <a name="special-thanks-to"></a><span data-ttu-id="c4df4-255">特别感谢</span><span class="sxs-lookup"><span data-stu-id="c4df4-255">Special Thanks To</span></span>

<span data-ttu-id="c4df4-256">很多有用的审阅者已评审本系列教程。</span><span class="sxs-lookup"><span data-stu-id="c4df4-256">This tutorial series was reviewed by many helpful reviewers.</span></span> <span data-ttu-id="c4df4-257">本教程中的潜在顾客审阅者已 Liz Shulok。</span><span class="sxs-lookup"><span data-stu-id="c4df4-257">Lead reviewer for this tutorial was Liz Shulok.</span></span> <span data-ttu-id="c4df4-258">是否有兴趣查看我即将推出的 MSDN 文章？</span><span class="sxs-lookup"><span data-stu-id="c4df4-258">Interested in reviewing my upcoming MSDN articles?</span></span> <span data-ttu-id="c4df4-259">如果是这样，给我在行[ mitchell@4GuysFromRolla.com。](mailto:mitchell@4GuysFromRolla.com)</span><span class="sxs-lookup"><span data-stu-id="c4df4-259">If so, drop me a line at [mitchell@4GuysFromRolla.com.](mailto:mitchell@4GuysFromRolla.com)</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="c4df4-260">[上一页](examining-the-events-associated-with-inserting-updating-and-deleting-cs.md)
> [下一页](adding-validation-controls-to-the-editing-and-inserting-interfaces-cs.md)</span><span class="sxs-lookup"><span data-stu-id="c4df4-260">[Previous](examining-the-events-associated-with-inserting-updating-and-deleting-cs.md)
[Next](adding-validation-controls-to-the-editing-and-inserting-interfaces-cs.md)</span></span>
